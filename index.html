<!doctype html>
<html lang="de"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ballers United â€“ Coach Tracker</title>
<link rel="icon" href="favicon.ico">
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0b0b0f">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icon-192.png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;900&family=Rajdhani:wght@600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0b0b0f;--muted:#a8a8b3;--text:#f4f4f7;--gold:#d4af37;--line:#242433;--chip:#1a1a26;
  --shadow:0 10px 30px rgba(0,0,0,.35);--r:16px;
  --mono:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
  --brandFont:"Rajdhani","Montserrat",sans-serif;
  --uiFont:"Montserrat","Inter",ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
}
*{box-sizing:border-box}
body{margin:0;font-family:var(--uiFont);color:var(--text);background:
  radial-gradient(1200px 800px at 20% -10%, rgba(212,175,55,.18), transparent 55%),
  radial-gradient(900px 600px at 120% 10%, rgba(90,140,255,.12), transparent 55%), var(--bg)}

/* â”€â”€ HEADER â”€â”€ */
header{position:sticky;top:0;z-index:99;background:rgba(11,11,15,.92);backdrop-filter:blur(16px);border-bottom:1px solid var(--line)}
.wrap{max-width:1200px;margin:0 auto;padding:10px 14px}
.topbar{display:flex;flex-direction:column;gap:8px}
@media(min-width:600px){.topbar{flex-direction:row;justify-content:space-between;align-items:center;gap:12px}}
.brand{display:flex;gap:10px;align-items:center;flex-shrink:0}
.logo{width:40px;height:40px;border-radius:10px;display:grid;place-items:center;font-weight:900;color:var(--gold);font-family:var(--brandFont);font-size:15px;letter-spacing:1px;
  background:linear-gradient(145deg,rgba(212,175,55,.35),rgba(212,175,55,.10));border:1px solid rgba(212,175,55,.35);box-shadow:var(--shadow)}
.brand h1{margin:0;font-size:16px;line-height:1.1;font-family:var(--brandFont);letter-spacing:1.5px;text-transform:uppercase;font-weight:700}
.brand small{display:block;color:var(--muted);font-weight:500;margin-top:1px;font-size:11px;letter-spacing:.3px}

/* â”€â”€ TABS: horizontal scroll on mobile â”€â”€ */
.tabs{display:flex;gap:5px;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;padding-bottom:2px;flex-shrink:1;min-width:0}
.tabs::-webkit-scrollbar{display:none}
.tab{background:transparent;color:var(--muted);border:1px solid var(--line);padding:6px 11px;border-radius:999px;cursor:pointer;font-weight:700;font-family:var(--uiFont);font-size:11px;letter-spacing:.3px;transition:all .15s ease;white-space:nowrap;flex-shrink:0}
.tab.active{color:var(--text);border-color:rgba(212,175,55,.65);background:rgba(212,175,55,.16)}
.tab:hover:not(.active){color:var(--text);border-color:rgba(212,175,55,.3);background:rgba(212,175,55,.06)}

/* â”€â”€ LAYOUT â”€â”€ */
main{padding:12px 12px 72px}
.grid{max-width:1200px;margin:0 auto;display:grid;gap:12px}
.row{display:grid;grid-template-columns:1fr;gap:12px}
@media(min-width:900px){.row.two{grid-template-columns:1.2fr .8fr}}
.card{background:rgba(18,18,26,.92);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);padding:16px}
.card h2{margin:0 0 10px;font-size:14px;font-family:var(--brandFont);letter-spacing:1px;text-transform:uppercase;font-weight:700}
.muted{color:var(--muted)}
.sep{height:1px;background:var(--line);margin:12px 0}

/* â”€â”€ BUTTONS â”€â”€ */
.btn{background:rgba(212,175,55,.18);border:1px solid rgba(212,175,55,.55);color:var(--text);padding:8px 14px;border-radius:12px;cursor:pointer;font-weight:700;font-family:var(--uiFont);font-size:13px;letter-spacing:.3px;transition:all .15s ease;touch-action:manipulation;-webkit-tap-highlight-color:transparent}
.btn:hover,.btn:active{background:rgba(212,175,55,.28);border-color:rgba(212,175,55,.8)}
.btn.secondary{background:transparent;border-color:var(--line);color:var(--muted)}
.btn.secondary:hover,.btn.secondary:active{border-color:rgba(212,175,55,.3);color:var(--text)}
.btn.danger{background:rgba(255,90,106,.12);border-color:rgba(255,90,106,.35);color:var(--text)}
.btn.danger:hover,.btn.danger:active{background:rgba(255,90,106,.22)}
.controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

/* â”€â”€ FORMS â”€â”€ */
input,select,textarea{width:100%;background:rgba(10,10,14,.6);border:1px solid var(--line);color:var(--text);padding:11px 12px;border-radius:12px;outline:none;font-family:var(--uiFont);font-size:16px;transition:border-color .15s}
/* font-size:16px prevents iOS zoom on focus */
input[type="date"],input[type="time"]{cursor:pointer;color-scheme:dark;}
input[type="date"]::-webkit-calendar-picker-indicator,
input[type="time"]::-webkit-calendar-picker-indicator{
  filter:invert(0.8) sepia(1) saturate(3) hue-rotate(5deg);
  cursor:pointer;opacity:.8;scale:1.2;
}
input:focus,select:focus,textarea:focus{border-color:rgba(212,175,55,.5)}
textarea{min-height:80px;resize:vertical;font-size:14px}
label{font-size:11px;color:var(--muted);display:block;margin:10px 0 4px;letter-spacing:.5px;text-transform:uppercase;font-weight:700}
.inline{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media(max-width:480px){.inline{grid-template-columns:1fr}}

/* â”€â”€ MODAL OVERLAY â”€â”€ */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:999;display:flex;align-items:flex-end;justify-content:center;padding:0}
@media(min-width:600px){.modal-overlay{align-items:center;padding:16px}}
.modal-sheet{background:rgba(18,18,26,.98);border:1px solid var(--line);border-radius:20px 20px 0 0;width:100%;max-height:92vh;overflow-y:auto;padding:20px 16px;box-shadow:0 -20px 60px rgba(0,0,0,.5)}
@media(min-width:600px){.modal-sheet{border-radius:20px;max-width:600px;max-height:88vh;padding:22px}}
.modal-sheet.wide{max-width:1000px}
.modal-handle{width:40px;height:4px;background:rgba(255,255,255,.2);border-radius:4px;margin:0 auto 18px}
@media(min-width:600px){.modal-handle{display:none}}

/* â”€â”€ TABLES: card-style on mobile â”€â”€ */
.table-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch}
@media(max-width:640px){
  .mobile-cards table,
  .mobile-cards thead{display:none}
  .mobile-cards .mobile-card-list{display:block}
}
@media(min-width:641px){
  .mobile-cards .mobile-card-list{display:none}
}
table{width:100%;border-collapse:collapse;font-size:13px;min-width:0}
th,td{padding:9px 8px;border-bottom:1px solid var(--line);text-align:left;vertical-align:middle}
th{color:var(--muted);font-weight:700;font-size:11px;letter-spacing:.5px;text-transform:uppercase}
/* compact table on small screens */
@media(max-width:640px){
  th,td{padding:7px 6px;font-size:12px}
}

/* â”€â”€ MISC â”€â”€ */
.mono{font-family:var(--mono)}
.chip{display:inline-flex;align-items:center;gap:4px;padding:3px 8px;border-radius:999px;background:var(--chip);border:1px solid var(--line);color:var(--muted);font-weight:700;font-size:11px;margin-right:4px;margin-top:4px;white-space:nowrap}
.chip.gold{border-color:rgba(212,175,55,.4);color:var(--text);background:rgba(212,175,55,.12)}
.chip.green{border-color:rgba(87,227,137,.4);color:#57e389;background:rgba(87,227,137,.08)}
.chip.red{border-color:rgba(255,90,106,.4);color:#ff6b7a;background:rgba(255,90,106,.08)}
.pill{font-family:var(--mono);padding:2px 7px;border-radius:8px;background:rgba(255,255,255,.06);border:1px solid var(--line);color:var(--muted);font-size:12px}
.notice{border-left:3px solid rgba(212,175,55,.55);background:rgba(212,175,55,.08);padding:10px 12px;border-radius:12px}
.row-actions{display:flex;gap:5px;flex-wrap:wrap}
.small{font-size:12px}

/* â”€â”€ TOOLTIP â”€â”€ */
.tooltip-wrap{position:relative;display:inline-flex;align-items:center;}
.tooltip-wrap .tip{position:absolute;bottom:calc(100% + 8px);left:0;transform:none;background:#1e1e2e;border:1px solid var(--line);color:var(--text);font-size:12px;padding:8px 10px;border-radius:10px;min-width:220px;max-width:min(300px,90vw);white-space:normal;z-index:1000;display:none;box-shadow:var(--shadow);}
.tooltip-wrap:hover .tip{display:block;}

/* â”€â”€ MATCHPLANNER PITCH â”€â”€ */
.slotGrid{display:grid;grid-template-columns:1fr;gap:10px}
@media(min-width:900px){.slotGrid{grid-template-columns:1fr 1fr}}
.pitch{border:1px solid rgba(212,175,55,.25);background:rgba(10,10,14,.35);border-radius:16px;padding:12px}
.slot{display:flex;align-items:center;justify-content:space-between;gap:8px;border:1px dashed rgba(212,175,55,.35);border-radius:12px;padding:9px;margin:6px 0;background:rgba(212,175,55,.05)}
.slot strong{font-family:var(--brandFont);letter-spacing:.5px;font-size:14px}
.draggable{border:1px solid var(--line);background:rgba(18,18,26,.92);border-radius:12px;padding:9px 10px;margin:6px 0;cursor:grab}
.draggable:active{cursor:grabbing}
.kv{display:flex;gap:6px;flex-wrap:wrap}
.kv .chip{margin-top:0}

/* â”€â”€ TAKTIKTAFEL â”€â”€ */
#tacticsField{width:100%;aspect-ratio:2/3;max-height:640px;background:#2d7a2d;
  border:3px solid rgba(255,255,255,.3);border-radius:12px;position:relative;overflow:hidden;cursor:crosshair;touch-action:none;}
#pitchSvg{position:absolute;inset:0;width:100%;height:100%;pointer-events:none;}
.field-line{position:absolute;background:rgba(255,255,255,.25)}
.player-token{position:absolute;width:44px;height:44px;border-radius:50%;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:grab;user-select:none;transform:translate(-50%,-50%);z-index:10;transition:box-shadow .1s;touch-action:none}
.player-token:active{cursor:grabbing;z-index:20;box-shadow:0 0 0 3px var(--gold)}
.player-token .tok-num{font-size:13px;font-weight:900;color:#fff;font-family:var(--brandFont);line-height:1}
.player-token .tok-name{font-size:8px;color:rgba(255,255,255,.9);font-weight:700;margin-top:1px;line-height:1;white-space:nowrap;max-width:48px;overflow:hidden;text-overflow:ellipsis}

/* â”€â”€ MOBILE SPECIFIC â”€â”€ */
@media(max-width:480px){
  .stat-grid{grid-template-columns:1fr 1fr!important}
  .card{padding:12px}
  .card h2{font-size:13px}
  .btn{padding:9px 12px;font-size:12px}
  main{padding:10px 10px 80px}
  .wrap{padding:8px 12px}
}
</style></head>
<body>
<header><div class="wrap"><div class="topbar">
<div class="brand"><div class="logo" style="padding:0;background:transparent;border:none;box-shadow:none;overflow:hidden;"><img src="data:image/png;base64,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" style="width:44px;height:44px;border-radius:10px;display:block;object-fit:cover;" alt="BU"></div><div><h1>Ballers United</h1><small>Coach Tracker â€“ Training Â· Matches Â· Entwicklung</small></div></div>
<div class="tabs" id="tabs"></div>
</div></div></header>
<main><div class="grid" id="view"></div></main>

<script>
const STORAGE_KEY="bu_coach_tracker_v2";

// â”€â”€ Torwart-Attribute (separat) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ATTRS_FIELD=[
  ["ausdauer","Ausdauer"],["tempo","Tempo"],["passspiel","Passspiel"],
  ["defensive","Defensive"],["abschluss","Abschluss"],["positioning","Positionierung"],
  ["dribbling","Dribbling"],["stellungsspiel","Stellungsspiel"],["physis","Physis"],
  ["kommunikation","Kommunikation"],["fitness","Fitness"]
];
const ATTRS_GK=[
  ["positionierung","Positionierung"],["hechten","Hechten"],["passspiel","Passspiel"],
  ["abstoss","AbstoÃŸ"],["auswurf","Auswurf"],["reflexe","Reflexe"],
  ["kommunikation","Kommunikation"],["fitness","Fitness"]
];

function getAttrs(pos){ return pos==="TW" ? ATTRS_GK : ATTRS_FIELD; }
function labelAttr(k,pos){
  const list = getAttrs(pos||"MF");
  const f=list.find(x=>x[0]===k);
  return f?f[1]:k;
}
function defaultAttrs(pos){
  const attrs={};
  getAttrs(pos).forEach(([k])=>attrs[k]=10);
  return attrs;
}

// Positionen auf Deutsch
const POSITIONS=["TW","IV","LA","RA","ZM","OM","DM","ST","LA/RA"];
const POSITION_LABELS={"TW":"Torwart","IV":"Innenverteidiger","LA":"LinksauÃŸen","RA":"RechtsauÃŸen","ZM":"Zentrales Mittelfeld","OM":"Offensives Mittelfeld","DM":"Defensives Mittelfeld","ST":"StÃ¼rmer","LA/RA":"AuÃŸen"};
// Legacy-Mapping: alte AbkÃ¼rzungen â†’ neue
const POS_COMPAT={"DF":"IV","MF":"ZM","GK":"TW"};
function normPos(pos){ return POS_COMPAT[pos]||pos; }
function posLabel(pos){ return POSITION_LABELS[normPos(pos)]||normPos(pos); }
function posGroup(pos){ return normPos(pos)==="TW"?"TW":"FELD"; }

const SQUAD_ROLES=["Stammspieler","Vereinsspieler","Gelegenheitsspieler"];
const SQUAD_ROLE_COMPAT={"Kern":"Stammspieler"};
function normRole(r){ return SQUAD_ROLE_COMPAT[r]||r; }

const FOCUS_PRESETS={
  "Kurzpass & Kombi":["passspiel","kommunikation","positioning"],
  "Defensive & Verschieben":["defensive","positioning","kommunikation"],
  "Tempo & Kondition":["tempo","ausdauer","fitness"],
  "Abschluss":["abschluss","passspiel","positioning"],
  "Allround":["fitness","passspiel","positioning"],
  "Torwart-Training":["hechten","reflexe","positionierung"]
};

const TABS=[
  {id:"dashboard",label:"Dashboard"},{id:"schedule",label:"Spielplan"},
  {id:"players",label:"Kader"},{id:"sessions",label:"Training"},
  {id:"library",label:"Trainingsbibliothek"},{id:"development",label:"Entwicklung"},
  {id:"planner",label:"Matchplanner"},{id:"matches",label:"Matches"},
  {id:"tactics",label:"Taktiktafel"},{id:"backup",label:"Backup"}
];

const SEED={
  meta:{teamName:"Ballers United",createdAt:"2026-02-21T00:00:00Z",coachMode:true},
  players:[
    {id:"p01",name:"Animesh",number:99,dob:"1993-11-20",nation:"Ã–sterreich",position:"TW",squadRole:"Stammspieler",isJoker:false,role:"Torwart (Spielaufbau)",notes:"",
      attrs:{positionierung:12,hechten:10,passspiel:11,abstoss:11,auswurf:10,reflexe:12,kommunikation:12,fitness:11},history:[],createdAt:"2026-02-21T00:00:00Z"},
    {id:"p02",name:"Arian",number:47,dob:"2004-11-04",nation:"Ã–sterreich",position:"IV",squadRole:"Vereinsspieler",isJoker:true,role:"Verteidiger (Joker)",notes:"",
      attrs:{ausdauer:11,tempo:11,passspiel:10,defensive:12,abschluss:8,positioning:11,kommunikation:10,fitness:11},history:[],createdAt:"2026-02-21T00:00:00Z"},
    {id:"p03",name:"Baki",number:14,dob:"1994-08-30",nation:"Ã–sterreich",position:"IV",squadRole:"Vereinsspieler",isJoker:true,role:"Verteidiger (Joker)",notes:"",
      attrs:{ausdauer:11,tempo:11,passspiel:10,defensive:12,abschluss:8,positioning:11,kommunikation:10,fitness:11},history:[],createdAt:"2026-02-21T00:00:00Z"},
    {id:"p04",name:"Bleon",number:20,dob:"2001-05-12",nation:"Ã–sterreich",position:"ST",squadRole:"Stammspieler",isJoker:false,role:"StÃ¼rmer (Zielspieler)",notes:"",
      attrs:{ausdauer:10,tempo:12,passspiel:10,defensive:8,abschluss:12,positioning:10,kommunikation:9,fitness:10},history:[],createdAt:"2026-02-21T00:00:00Z"},
    {id:"p05",name:"Daniel",number:8,dob:"1995-06-22",nation:"Ã–sterreich",position:"ST",squadRole:"Stammspieler",isJoker:false,role:"StÃ¼rmer (Wandspieler)",notes:"",
      attrs:{ausdauer:10,tempo:12,passspiel:10,defensive:8,abschluss:12,positioning:10,kommunikation:9,fitness:10},history:[],createdAt:"2026-02-21T00:00:00Z"},
    {id:"p06",name:"Dave",number:15,dob:"1994-04-20",nation:"Ã–sterreich",position:"IV",squadRole:"Stammspieler",isJoker:false,role:"Verteidiger (Tempo/Absicherung)",notes:"",
      attrs:{ausdauer:11,tempo:11,passspiel:10,defensive:12,abschluss:8,positioning:11,kommunikation:10,fitness:11},history:[],createdAt:"2026-02-21T00:00:00Z"},
    {id:"p07",name:"Mahian",number:17,dob:"2002-07-23",nation:"Ã–sterreich",position:"DM",squadRole:"Stammspieler",isJoker:false,role:"Hybrid (MF/IV Motor)",notes:"",
      attrs:{ausdauer:11,tempo:11,passspiel:10,defensive:12,abschluss:8,positioning:11,kommunikation:10,fitness:11},history:[],createdAt:"2026-02-21T00:00:00Z"},
    {id:"p08",name:"Mario",number:22,dob:"1993-03-20",nation:"Ã–sterreich",position:"ZM",squadRole:"Stammspieler",isJoker:false,role:"Allrounder",notes:"",
      attrs:{ausdauer:11,tempo:11,passspiel:12,defensive:10,abschluss:9,positioning:10,kommunikation:10,fitness:11},history:[],createdAt:"2026-02-21T00:00:00Z"},
    {id:"p09",name:"Obl",number:44,dob:"2002-04-06",nation:"Ã–sterreich",position:"TW",squadRole:"Vereinsspieler",isJoker:true,role:"Torwart (Joker)",notes:"",
      attrs:{positionierung:12,hechten:9,passspiel:10,abstoss:10,auswurf:9,reflexe:11,kommunikation:11,fitness:10},history:[],createdAt:"2026-02-21T00:00:00Z"},
    {id:"p10",name:"Rasih",number:4,dob:"1994-11-20",nation:"Ã–sterreich",position:"IV",squadRole:"Stammspieler",isJoker:false,role:"Verteidiger (Sicherheit)",notes:"",
      attrs:{ausdauer:11,tempo:11,passspiel:10,defensive:12,abschluss:8,positioning:11,kommunikation:10,fitness:11},history:[],createdAt:"2026-02-21T00:00:00Z"},
    {id:"p11",name:"Reisi",number:7,dob:"1994-08-10",nation:"Ã–sterreich",position:"ZM",squadRole:"Vereinsspieler",isJoker:true,role:"Mittelfeldspieler (Joker)",notes:"",
      attrs:{ausdauer:11,tempo:11,passspiel:12,defensive:10,abschluss:9,positioning:10,kommunikation:10,fitness:11},history:[],createdAt:"2026-02-21T00:00:00Z"},
    {id:"p12",name:"Rexha",number:9,dob:"1996-09-27",nation:"Ã–sterreich",position:"ZM",squadRole:"Stammspieler",isJoker:false,role:"Mittelfeldspieler",notes:"",
      attrs:{ausdauer:11,tempo:11,passspiel:12,defensive:10,abschluss:9,positioning:10,kommunikation:10,fitness:11},history:[],createdAt:"2026-02-21T00:00:00Z"},
    {id:"p13",name:"Robin",number:10,dob:"1994-11-02",nation:"Ã–sterreich",position:"OM",squadRole:"Stammspieler",isJoker:false,role:"KapitÃ¤n / Spielmacher",notes:"",
      attrs:{ausdauer:11,tempo:11,passspiel:12,defensive:10,abschluss:9,positioning:10,kommunikation:10,fitness:11},history:[],createdAt:"2026-02-21T00:00:00Z"},
    {id:"p14",name:"Rohan",number:2,dob:"2003-04-26",nation:"Ã–sterreich",position:"IV",squadRole:"Stammspieler",isJoker:false,role:"Verteidiger (Entwicklung)",notes:"",
      attrs:{ausdauer:11,tempo:11,passspiel:10,defensive:12,abschluss:8,positioning:11,kommunikation:10,fitness:11},history:[],createdAt:"2026-02-21T00:00:00Z"},
    {id:"p15",name:"Sadi",number:27,dob:"2000-10-12",nation:"Ã–sterreich",position:"IV",squadRole:"Stammspieler",isJoker:false,role:"Spielaufbauender Verteidiger",notes:"",
      attrs:{ausdauer:11,tempo:11,passspiel:10,defensive:12,abschluss:8,positioning:11,kommunikation:10,fitness:11},history:[],createdAt:"2026-02-21T00:00:00Z"},
    {id:"p16",name:"Tazimm",number:80,dob:"2002-01-03",nation:"Ã–sterreich",position:"LA/RA",squadRole:"Gelegenheitsspieler",isJoker:true,role:"AuÃŸenstÃ¼rmer (Tiefe)",notes:"",
      attrs:{ausdauer:10,tempo:12,passspiel:10,defensive:8,abschluss:12,positioning:10,kommunikation:9,fitness:10},history:[],createdAt:"2026-02-21T00:00:00Z"},
    {id:"p17",name:"Werdi",number:26,dob:"1994-02-26",nation:"Ã–sterreich",position:"ZM",squadRole:"Vereinsspieler",isJoker:true,role:"Mittelfeldspieler (Joker)",notes:"",
      attrs:{ausdauer:11,tempo:11,passspiel:12,defensive:10,abschluss:9,positioning:10,kommunikation:10,fitness:11},history:[],createdAt:"2026-02-21T00:00:00Z"},
    {id:"p18",name:"Edi",number:19,dob:"2002-02-11",nation:"Ã–sterreich",position:"ZM",squadRole:"Vereinsspieler",isJoker:true,role:"Mittelfeldspieler (Joker)",notes:"",
      attrs:{ausdauer:11,tempo:11,passspiel:12,defensive:10,abschluss:9,positioning:10,kommunikation:10,fitness:11},history:[],createdAt:"2026-02-21T00:00:00Z"},
    {id:"p19",name:"Dennis",number:21,dob:"1996-07-24",nation:"Ã–sterreich",position:"ST",squadRole:"Gelegenheitsspieler",isJoker:true,role:"StÃ¼rmer (Wandspieler)",notes:"",
      attrs:{ausdauer:10,tempo:12,passspiel:10,defensive:8,abschluss:12,positioning:10,kommunikation:9,fitness:10},history:[],createdAt:"2026-02-21T00:00:00Z"},
    {id:"p20",name:"Flavio",number:11,dob:"2005-01-17",nation:"Ã–sterreich",position:"ST",squadRole:"Vereinsspieler",isJoker:true,role:"StÃ¼rmer (Joker)",notes:"",
      attrs:{ausdauer:10,tempo:12,passspiel:10,defensive:8,abschluss:12,positioning:10,kommunikation:9,fitness:10},history:[],createdAt:"2026-02-21T00:00:00Z"}
  ],
  sessions:[],
  matches:[],
  schedule:[
    {id:"s1",date:"2026-03-15",time:"09:00",opponent:"Viktoria Altmannsdorf",home:true,location:"ASK Erlaa",description:"Treffpunkt: 08:15 Uhr. Trikot + Ausweis mitbringen."},
    {id:"s2",date:"2026-04-12",time:"09:00",opponent:"FC Equipo",home:false,location:"ASK Erlaa",description:""},
    {id:"s3",date:"2026-04-26",time:"10:00",opponent:"FC Union 12",home:true,location:"ASK Erlaa",description:""},
    {id:"s4",date:"2026-05-01",time:"10:00",opponent:"The Branko Boys",home:false,location:"ASK Erlaa",description:""},
    {id:"s5",date:"2026-05-10",time:"09:00",opponent:"1. FC Court",home:true,location:"ASK Erlaa",description:""},
    {id:"s6",date:"2026-05-31",time:"20:00",opponent:"Die KÃ¤fig Krocha",home:false,location:"ASK Erlaa",description:""},
    {id:"s7",date:"2026-06-07",time:"20:00",opponent:"FC Haudaneben 25",home:true,location:"ASK Erlaa",description:""},
    {id:"s8",date:"2026-06-14",time:"10:00",opponent:"FC Wiesen",home:false,location:"ASK Erlaa",description:""}
  ],
  settings:{tz:"Europe/Vienna",baseGain:0.2,rpeMultiplier:0.04,maxGain:0.6,minGain:0.05,
    trainingDay:"Donnerstag",trainingTime:"20:00â€“21:30",trainingLocation:"ASK Erlaa"}
};

function loadState(){
  try{
    const raw=localStorage.getItem(STORAGE_KEY);
    if(!raw) return structuredClone(SEED);
    const p=JSON.parse(raw);
    // migrate old storage key v1
    return p;
  }catch(e){return structuredClone(SEED);}
}
function saveState(){localStorage.setItem(STORAGE_KEY,JSON.stringify(state));}
let state=loadState();

// backward compat migration
function migrateState(){
  state.library=state.library||defaultLibrary();
  state.plans=state.plans||[];
  state.matchPlans=state.matchPlans||[];
  state.players=state.players||[];
  state.schedule=state.schedule||[];
  state.matches=state.matches||[];
  state.sessions=state.sessions||[];
  state.settings=Object.assign({trainingDay:"Donnerstag",trainingTime:"20:00â€“21:30",trainingLocation:"ASK Erlaa"},state.settings||{});
  state.players.forEach(p=>{
    p.history=p.history||[];
    p.position=normPos(p.position);
    p.squadRole=normRole(p.squadRole||"Vereinsspieler");
    // if old attrs don't match position, migrate
    const expectedKeys=getAttrs(p.position).map(a=>a[0]);
    const hasNew=expectedKeys.some(k=>p.attrs[k]!==undefined);
    if(!hasNew){
      const old=p.attrs||{};
      if(p.position==="TW"){
        p.attrs={positionierung:old.positioning||10,hechten:10,passspiel:old.passing||10,abstoss:old.shooting||10,auswurf:10,reflexe:old.positioning||10,kommunikation:old.communication||10,fitness:old.fitness||10};
      } else {
        p.attrs={ausdauer:old.stamina||10,tempo:old.pace||10,passspiel:old.passing||10,defensive:old.defending||10,abschluss:old.shooting||10,positioning:old.positioning||10,kommunikation:old.communication||10,fitness:old.fitness||10};
      }
    }
  });
  state.schedule.forEach(g=>{
    if(!g.id) g.id="sg_"+Math.random().toString(16).slice(2);
    if(g.description===undefined) g.description="";
    if(!g.gameType) g.gameType="Ligaspiel";
  });
}
migrateState();

// helpers
function el(h){const t=document.createElement("template");t.innerHTML=h.trim();return t.content.firstChild;}
function clamp(n,a,b){return Math.max(a,Math.min(b,n));}
function round1(n){return Math.round(n*10)/10;}
function escapeHtml(s){return(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");}
function escapeAttr(s){return escapeHtml(s).replaceAll('"',"&quot;");}
function uid(){return Math.random().toString(16).slice(2)+"-"+Date.now().toString(16);}

// next Thursday helper
function nextThursday(){
  const now=new Date();const day=now.getDay();
  const diff=(4-day+7)%7||7;
  const d=new Date(now);d.setDate(now.getDate()+diff);
  return d.toISOString().slice(0,10);
}

// â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentTab="dashboard";
function renderTabs(){
  const root=document.getElementById("tabs");root.innerHTML="";
  TABS.forEach(t=>{
    const b=el(`<button class="tab ${t.id===currentTab?"active":""}">${t.label}</button>`);
    b.onclick=()=>{currentTab=t.id;render();};root.appendChild(b);
  });
}
function render(){
  renderTabs();
  const v=document.getElementById("view");v.innerHTML="";
  if(currentTab==="dashboard") v.appendChild(renderDashboard());
  if(currentTab==="schedule") v.appendChild(renderSchedule());
  if(currentTab==="players") v.appendChild(renderPlayers());
  if(currentTab==="sessions") v.appendChild(renderSessions());
  if(currentTab==="library") v.appendChild(renderLibrary());
  if(currentTab==="development") v.appendChild(renderDevelopment());
  if(currentTab==="planner") v.appendChild(renderPlanner());
  if(currentTab==="matches") v.appendChild(renderMatches());
  if(currentTab==="tactics") v.appendChild(renderTactics());
  if(currentTab==="backup") v.appendChild(renderBackup());
}

// â”€â”€ DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderDashboard(){
  const players=state.players||[];const sessions=state.sessions||[];
  const stamm=players.filter(p=>p.squadRole==="Stammspieler").length;
  const verein=players.filter(p=>p.squadRole==="Vereinsspieler").length;
  const gelegenhei=players.filter(p=>p.squadRole==="Gelegenheitsspieler").length;
  const matchCount=(state.matches||[]).length;
  const root=el(`<div class="grid"></div>`);
  const top=el(`<div class="row two">
    <div class="card">
      <h2>Coach Dashboard</h2>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:4px;" class="stat-grid">
        <div class="card" style="padding:12px;text-align:center;border-color:rgba(212,175,55,.3);">
          <div style="font-size:22px;font-weight:900;color:var(--gold);">${players.length}</div>
          <div class="muted small">Gesamt Spieler</div>
        </div>
        <div class="card" style="padding:12px;text-align:center;border-color:rgba(212,175,55,.3);">
          <div style="font-size:22px;font-weight:900;color:var(--gold);">${sessions.length}</div>
          <div class="muted small">Trainings</div>
        </div>
        <div class="card" style="padding:12px;text-align:center;border-color:rgba(212,175,55,.3);">
          <div style="font-size:22px;font-weight:900;color:var(--gold);">${matchCount}</div>
          <div class="muted small">Matches</div>
        </div>
      </div>
      <div class="controls" style="gap:6px;margin-bottom:4px;">
        <span class="chip gold">â­ Stammspieler: <b>${stamm}</b></span>
        <span class="chip">ğŸŸ¡ Vereinsspieler: <b>${verein}</b></span>
        <span class="chip">âš¡ Gelegenheitsspieler: <b>${gelegenhei}</b></span>
      </div>
      <div class="sep"></div>
      <div class="notice">Standard-Anwesenheit: nur <b>Stammspieler</b> vorausgewÃ¤hlt (jederzeit Ã¤nderbar).</div>
      <div class="sep"></div>
      <h2>NÃ¤chste Spiele</h2>
      ${renderNextGames()}
      <div class="sep"></div>
      <button class="btn secondary" id="icsBtn">Spielplan als .ics exportieren</button>
    </div>
    <div class="card">
      <h2>NÃ¤chstes Training</h2>
      ${renderNextTraining()}
      <div class="sep"></div>
      <h2>Letzte Trainings</h2>
      ${renderLastSessions()}
    </div>
  </div>`);
  top.querySelector("#icsBtn").onclick=exportICS;
  root.appendChild(top);return root;
}
function renderNextGames(){
  const now=new Date();
  const list=(state.schedule||[]).map(g=>({...g,dt:new Date(g.date+"T"+(g.time||"00:00")+":00")}))
    .sort((a,b)=>a.dt-b.dt).filter(g=>g.dt>=new Date(now.getTime()-86400000)).slice(0,4);
  if(!list.length) return `<p class="muted">Kein Spielplan eingetragen.</p>`;
  return `<table><thead><tr><th>Datum</th><th>Zeit</th><th>Match</th><th>Ort</th></tr></thead><tbody>`+
    list.map(g=>`<tr><td class="mono">${g.date}</td><td class="mono">${g.time}</td>
      <td><b>${g.home?"Ballers United":escapeHtml(g.opponent)}</b> vs <b>${g.home?escapeHtml(g.opponent):"Ballers United"}</b></td>
      <td>${escapeHtml(g.location||"")}</td></tr>`).join("")+`</tbody></table>`;
}
function renderNextTraining(){
  const s=state.settings||{};
  const nextThu=nextThursday();
  const d=new Date(nextThu+"T00:00:00");
  const dateStr=d.toLocaleDateString("de-AT",{weekday:"long",day:"2-digit",month:"2-digit",year:"numeric"});
  return `<div class="notice" style="display:flex;gap:12px;align-items:center;">
    <span style="font-size:2em;">âš½</span>
    <div>
      <div style="font-weight:700;color:var(--gold);">${dateStr}</div>
      <div style="font-size:13px;margin-top:4px;">ğŸ•— ${s.trainingTime||"20:00â€“21:30"} &nbsp;Â·&nbsp; ğŸ“ ${s.trainingLocation||"ASK Erlaa"}</div>
      <span class="chip gold" style="margin-top:6px;">Jeden ${s.trainingDay||"Donnerstag"}</span>
    </div>
  </div>`;
}
function renderLastSessions(){
  const s=[...(state.sessions||[])].sort((a,b)=>(b.date||"").localeCompare(a.date||"")).slice(0,5);
  if(!s.length) return `<p class="muted">Noch keine Trainings erfasst.</p>`;
  return `<table><thead><tr><th>Datum</th><th>Fokus</th><th>Belastung</th></tr></thead><tbody>`+
    s.map(x=>`<tr><td class="mono">${x.date||"-"}</td>
      <td>${(x.focus||[]).map(f=>`<span class="chip gold">${escapeHtml(f)}</span>`).join("")}</td>
      <td><span class="pill">${x.rpe||"-"}</span></td></tr>`).join("")+`</tbody></table>`;
}

// â”€â”€ SPIELPLAN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderSchedule(){
  const root=el(`<div class="grid"></div>`);
  const card=el(`<div class="card">
    <div class="controls" style="justify-content:space-between;">
      <h2 style="margin:0;">Spielplan 2026</h2>
      <div class="controls">
        <button class="btn secondary" id="icsBtn">.ics Export</button>
        <button class="btn" id="addBtn">+ Spiel</button>
      </div>
    </div>
    <div class="sep"></div>
    <div class="table-wrap" id="tableWrap">${renderScheduleTable()}</div>
  </div>`);
  card.querySelector("#icsBtn").onclick=exportICS;
  card.querySelector("#addBtn").onclick=()=>openGameModal(null);
  root.appendChild(card);return root;
}
function renderScheduleTable(){
  const list=[...(state.schedule||[])].sort((a,b)=>(a.date+a.time).localeCompare(b.date+b.time));
  if(!list.length) return `<p class="muted">Noch keine Spiele eingetragen.</p>`;
  function typeChip(g){return g.gameType==="Pokalspiel"?'<span class="chip green">ğŸ¥‡ Pokal</span>':g.gameType==="Testspiel"?'<span class="chip">ğŸ¯ Test</span>':'<span class="chip gold">ğŸ† Liga</span>';}
  function result(g){
    const linked=(state.matches||[]).find(m=>m.scheduleId===g.id);
    return linked?.score?`<span class="chip ${linked.score.split(":").map(Number)[0]>linked.score.split(":").map(Number)[1]?"green":linked.score.split(":").map(Number)[0]<linked.score.split(":").map(Number)[1]?"red":""}">${escapeHtml(linked.score)}</span>`:"â€“";
  }
  function actions(g){return `<div class="row-actions">
    <button class="btn secondary" onclick="editGame('${g.id}')" title="Bearbeiten">âœï¸</button>
    <button class="btn secondary" onclick="addMatchFromGame('${g.id}')" title="Ergebnis eintragen">âš½</button>
    <button class="btn danger" onclick="deleteGame('${g.id}')" title="LÃ¶schen">ğŸ—‘</button>
  </div>`;}
  const tableHtml=`<table><thead><tr><th>Datum</th><th>Zeit</th><th>Gegner</th><th>H/A</th><th>Art</th><th>Ort</th><th>Ergebnis</th><th>Aktionen</th></tr></thead><tbody>`+
    list.map(g=>`<tr>
      <td class="mono" style="white-space:nowrap">${g.date}</td><td class="mono">${g.time}</td>
      <td><b>${escapeHtml(g.opponent)}</b></td>
      <td>${g.home?'<span class="chip gold">H</span>':'<span class="chip">A</span>'}</td>
      <td>${typeChip(g)}</td>
      <td style="white-space:nowrap">${escapeHtml(g.location||"")}</td>
      <td>${result(g)}</td>
      <td>${actions(g)}</td></tr>`).join("")+`</tbody></table>`;
  const cardsHtml=`<div class="mobile-card-list">`+list.map(g=>`
    <div style="border:1px solid var(--line);border-radius:14px;padding:12px;margin-bottom:8px;background:rgba(18,18,26,.8);">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:6px;">
        <div>
          <div style="font-weight:700;font-size:15px;">${escapeHtml(g.opponent)}</div>
          <div class="muted small">${g.date} &nbsp;Â·&nbsp; ${g.time}</div>
        </div>
        <div style="text-align:right;">${typeChip(g)}${g.home?'<span class="chip gold">Heim</span>':'<span class="chip">AuswÃ¤rts</span>'}</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:8px;">
        ${result(g)!=="â€“"?`<b style="font-size:16px;font-weight:900;">${result(g)}</b>`:""}
        ${g.location?`<span class="muted small">ğŸ“ ${escapeHtml(g.location)}</span>`:""}
        ${g.description?`<span class="muted small">${escapeHtml(g.description)}</span>`:""}
      </div>
      ${actions(g)}
    </div>`).join("")+`</div>`;
  return `<div class="mobile-cards">${tableHtml}${cardsHtml}</div>`;
}
function openGameModal(id){
  const existing=id ? state.schedule.find(x=>x.id===id) : null;
  const g=existing?structuredClone(existing):{
    id:uid(),date:new Date().toISOString().slice(0,10),time:"09:00",
    opponent:"",home:true,location:"ASK Erlaa",description:"",gameType:"Ligaspiel"
  };
  if(!g.gameType) g.gameType="Ligaspiel";
  const modal=el(`<div class="modal-overlay">
    <div class="modal-sheet">
      <div class="modal-handle"></div>
      <div class="controls" style="justify-content:space-between;">
        <h2 style="margin:0;">${existing?"Spiel bearbeiten":"Neues Spiel"}</h2>
        <button class="btn secondary" id="close">SchlieÃŸen</button>
      </div>
      <div class="inline" style="margin-top:12px;">
        <div><label>Datum</label><input id="date" type="date" value="${g.date}"></div>
        <div><label>AnstoÃŸ</label><input id="time" type="time" value="${g.time}"></div>
      </div>
      <label>Gegner</label><input id="opp" value="${escapeAttr(g.opponent||"")}">
      <div class="inline">
        <div><label>Spielart</label><select id="gameType">
          <option value="Ligaspiel" ${g.gameType==="Ligaspiel"?"selected":""}>ğŸ† Ligaspiel</option>
          <option value="Pokalspiel" ${g.gameType==="Pokalspiel"?"selected":""}>ğŸ¥‡ Pokalspiel</option>
          <option value="Testspiel" ${g.gameType==="Testspiel"?"selected":""}>ğŸ¯ Testspiel</option>
        </select></div>
        <div><label>Heim / AuswÃ¤rts</label><select id="home">
          <option value="home" ${g.home?"selected":""}>ğŸ  Heim</option>
          <option value="away" ${!g.home?"selected":""}>âœˆï¸ AuswÃ¤rts</option>
        </select></div>
      </div>
      <div><label>Ort / Platz</label><input id="loc" value="${escapeAttr(g.location||"")}"></div>
      <label>Treffpunkt / Infos</label>
      <textarea id="desc" placeholder="z.B. Treffpunkt: 08:15 Uhr Â· Trikot + Ausweis mitbringen">${escapeHtml(g.description||"")}</textarea>
      <div class="sep"></div>
      <div class="controls" style="justify-content:flex-end;">
        <button class="btn" id="save">Speichern</button>
      </div>
    </div></div>`);
  modal.querySelector("#close").onclick=()=>modal.remove();
  modal.querySelector("#save").onclick=()=>{
    g.date=modal.querySelector("#date").value;
    g.time=modal.querySelector("#time").value||"00:00";
    g.opponent=modal.querySelector("#opp").value.trim()||"TBD";
    g.gameType=modal.querySelector("#gameType").value;
    g.home=modal.querySelector("#home").value==="home";
    g.location=modal.querySelector("#loc").value.trim();
    g.description=modal.querySelector("#desc").value.trim();
    if(existing){
      const idx=state.schedule.findIndex(x=>x.id===g.id);
      if(idx>=0) state.schedule[idx]=g;
    } else {
      state.schedule.push(g);
    }
    saveState();render();modal.remove();
  };
  document.body.appendChild(modal);
}
window.editGame=(id)=>openGameModal(id);
window.deleteGame=(id)=>{if(!confirm("Spiel wirklich lÃ¶schen?")) return; state.schedule=state.schedule.filter(x=>x.id!==id); saveState();render();};
window.addMatchFromGame=(scheduleId)=>{
  const g=state.schedule.find(x=>x.id===scheduleId);
  if(!g) return;
  const existing=(state.matches||[]).find(m=>m.scheduleId===scheduleId);
  if(existing){
    currentTab="matches"; render();
    setTimeout(()=>openMatchModal(existing),30);
    return;
  }
  const m={
    id:uid(),date:g.date,opponent:g.opponent,home:g.home,
    gameType:g.gameType||"Ligaspiel",scheduleId:scheduleId,
    score:"",notes:"",teamFeedback:"",
    stats:(state.players||[]).map(p=>({playerId:p.id,available:p.squadRole==="Stammspieler",minutes:0,goals:0,assists:0,rating:6,yellow:0,red:0,feedback:""}))
  };
  currentTab="matches"; render();
  setTimeout(()=>openMatchModal(m),30);
};

function exportICS(){
  const tzid="Europe/Vienna";const dtstamp=new Date().toISOString().replace(/[-:]/g,"").split(".")[0]+"Z";
  function fmtLocal(ds,ts){const[y,m,d]=ds.split("-");const[hh,mm]=ts.split(":");return `${y}${m}${d}T${hh}${mm}00`;}
  function esc(s){return(s||"").replace(/\\/g,"\\\\").replace(/,/g,"\\,").replace(/;/g,"\\;").replace(/\n/g,"\\n");}
  const lines=["BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//Ballers United//Coach Tracker//DE","CALSCALE:GREGORIAN","METHOD:PUBLISH"];
  (state.schedule||[]).forEach(g=>{
    const start=fmtLocal(g.date,g.time||"00:00");
    const dt=new Date(g.date+"T"+(g.time||"00:00")+":00");const endDt=new Date(dt.getTime()+90*60000);
    const endLocal=endDt.toISOString().replace(/[-:]/g,"").split(".")[0];const el2=endLocal.slice(0,8)+"T"+endLocal.slice(9,15);
    const summary=g.home?`Ballers United vs. ${g.opponent}`:`${g.opponent} vs. Ballers United`;
    const desc=g.description||"Treffpunkt: 45 min vor AnstoÃŸ Â· Trikot + Ausweis mitbringen";
    lines.push("BEGIN:VEVENT","UID:"+uid()+"@bu","DTSTAMP:"+dtstamp,`DTSTART;TZID=${tzid}:${start}`,`DTEND;TZID=${tzid}:${el2}`,
      "SUMMARY:"+esc(summary),"LOCATION:"+esc(g.location||""),"DESCRIPTION:"+esc(desc),"END:VEVENT");
  });
  lines.push("END:VCALENDAR");
  const blob=new Blob([lines.join("\r\n")+"\r\n"],{type:"text/calendar;charset=utf-8"});
  const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="Ballers_United.ics";document.body.appendChild(a);a.click();a.remove();
}

// â”€â”€ KADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderPlayers(){
  const root=el(`<div class="grid"></div>`);
  const card=el(`<div class="card">
    <div class="controls" style="justify-content:space-between;">
      <h2 style="margin:0;">Kader</h2>
      <button class="btn" id="add">+ Spieler</button>
    </div>
    <div class="sep"></div>
    <div class="table-wrap" id="tbl">${renderPlayersTable()}</div>
  </div>`);
  card.querySelector("#add").onclick=()=>openPlayerModal(null);
  root.appendChild(card);return root;
}
function renderPlayersTable(){
  const ps=[...(state.players||[])].sort((a,b)=>a.name.localeCompare(b.name));
  function roleChip(p){return p.squadRole==="Stammspieler"?'<span class="chip gold">â­ Stamm</span>':p.squadRole==="Vereinsspieler"?'<span class="chip">ğŸŸ¡ Verein</span>':'<span class="chip">âš¡ Gelegenheit</span>';}
  const tableHtml=`<table><thead><tr><th>Name</th><th>#</th><th>Pos.</th><th>Rolle</th><th>Aktionen</th></tr></thead><tbody>`+
    ps.map(p=>`<tr>
      <td><b>${escapeHtml(p.name)}</b><div class="muted small">${escapeHtml(p.nation||"")}${p.dob?" Â· "+p.dob:""}</div></td>
      <td class="mono">${p.number??""}</td>
      <td><span class="chip">${posLabel(p.position)}</span></td>
      <td>${roleChip(p)}</td>
      <td><div class="row-actions">
        <button class="btn secondary" onclick="editPlayer('${p.id}')">âœï¸</button>
        <button class="btn danger" onclick="deletePlayer('${p.id}')">ğŸ—‘</button>
      </div></td></tr>`).join("")+`</tbody></table>`;
  const cardsHtml=`<div class="mobile-card-list">`+ps.map(p=>`
    <div style="border:1px solid var(--line);border-radius:14px;padding:12px;margin-bottom:8px;background:rgba(18,18,26,.8);display:flex;align-items:center;gap:12px;">
      <div style="width:42px;height:42px;border-radius:50%;background:rgba(212,175,55,.15);border:1px solid rgba(212,175,55,.3);display:flex;align-items:center;justify-content:center;font-weight:900;font-family:var(--brandFont);font-size:16px;color:var(--gold);flex-shrink:0;">${p.number??""}</div>
      <div style="flex:1;min-width:0;">
        <div style="font-weight:700;font-size:15px;">${escapeHtml(p.name)}</div>
        <div style="display:flex;flex-wrap:wrap;gap:3px;margin-top:3px;">
          <span class="chip">${posLabel(p.position)}</span>${roleChip(p)}
          ${p.nation?`<span class="muted small" style="margin-top:4px;">${escapeHtml(p.nation)}</span>`:""}
        </div>
      </div>
      <div style="display:flex;flex-direction:column;gap:6px;flex-shrink:0;">
        <button class="btn secondary" onclick="editPlayer('${p.id}')" style="padding:7px 10px;">âœï¸</button>
        <button class="btn danger" onclick="deletePlayer('${p.id}')" style="padding:7px 10px;">ğŸ—‘</button>
      </div>
    </div>`).join("")+`</div>`;
  return `<div class="mobile-cards">${tableHtml}${cardsHtml}</div>`;
}
function openPlayerModal(player){
  const isNew=!player;
  const p=isNew?{id:uid(),name:"",number:"",dob:"",nation:"Ã–sterreich",position:"ZM",squadRole:"Stammspieler",isJoker:false,role:"",notes:"",
    attrs:defaultAttrs("ZM"),history:[],createdAt:new Date().toISOString()}:structuredClone(player);
  const pos=normPos(p.position||"ZM");
  const attrsForPos=getAttrs(pos);
  const modal=el(`<div class="modal-overlay">
    <div class="modal-sheet">
      <div class="modal-handle"></div>
      <div class="controls" style="justify-content:space-between;">
        <h2 style="margin:0;">${isNew?"Neuer Spieler":"Spieler bearbeiten"}</h2>
        <button class="btn secondary" id="close">SchlieÃŸen</button>
      </div>
      <div class="inline" style="margin-top:12px;">
        <div><label>Name</label><input id="name" value="${escapeAttr(p.name)}"></div>
        <div><label>RÃ¼ckennummer</label><input id="num" type="number" value="${p.number??""}"></div>
      </div>
      <div class="inline">
        <div><label>Geburtstag</label><input id="dob" type="date" value="${p.dob||""}"></div>
        <div><label>Nation</label><input id="nat" value="${escapeAttr(p.nation||"")}"></div>
      </div>
      <div class="inline">
        <div><label>Position</label>
          <select id="pos">
            ${POSITIONS.map(x=>`<option value="${x}" ${normPos(p.position)===x?"selected":""}>${posLabel(x)} (${x})</option>`).join("")}
          </select>
        </div>
        <div><label>Status</label>
          <select id="sr">
            ${SQUAD_ROLES.map(x=>`<option value="${x}" ${normRole(p.squadRole||"Vereinsspieler")===x?"selected":""}>${x}</option>`).join("")}
          </select>
        </div>
      </div>
      <label>Rolle / Beschreibung</label><input id="role" value="${escapeAttr(p.role||"")}">
      <label>Notizen</label><textarea id="notes">${escapeHtml(p.notes||"")}</textarea>
      <div class="sep"></div>
      <h2 style="margin:0 0 8px;">Attribute (1â€“20)</h2>
      <div class="notice small" id="attrNote">${pos==="TW"?"Torwart-Attribute aktiv":"Feldspieler-Attribute aktiv"}</div>
      <div id="attrFields" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px;">
        ${attrsForPos.map(([k,l])=>`<div><label>${l}</label><input id="attr_${k}" type="number" min="1" max="20" step="0.5" value="${p.attrs?.[k]??10}"></div>`).join("")}
      </div>
      <div class="sep"></div>
      <div class="controls" style="justify-content:flex-end;">
        <button class="btn" id="save">Speichern</button>
      </div>
    </div></div>`);
  // Re-render attrs when position changes
  modal.querySelector("#pos").onchange=(e)=>{
    const newPos=e.target.value;
    const newAttrs=getAttrs(newPos);
    modal.querySelector("#attrNote").textContent=newPos==="TW"?"Torwart-Attribute aktiv":"Feldspieler-Attribute aktiv";
    modal.querySelector("#attrFields").innerHTML=newAttrs.map(([k,l])=>`<div><label>${l}</label><input id="attr_${k}" type="number" min="1" max="20" step="0.5" value="${p.attrs?.[k]??10}"></div>`).join("");
  };
  modal.querySelector("#close").onclick=()=>modal.remove();
  modal.querySelector("#save").onclick=()=>{
    const name=modal.querySelector("#name").value.trim();if(!name) return alert("Bitte Name eingeben.");
    const newPos=modal.querySelector("#pos").value;
    const newAttrs=getAttrs(newPos);
    const attrs={};
    newAttrs.forEach(([k])=>{const v=parseFloat(modal.querySelector(`#attr_${k}`)?.value);attrs[k]=clamp(isNaN(v)?10:v,1,20);});
    p.name=name;p.number=parseInt(modal.querySelector("#num").value,10)||"";
    p.dob=modal.querySelector("#dob").value;p.nation=modal.querySelector("#nat").value.trim();
    p.position=newPos;p.squadRole=modal.querySelector("#sr").value;
    p.isJoker=p.squadRole!=="Stammspieler";
    p.role=modal.querySelector("#role").value.trim();
    p.notes=modal.querySelector("#notes").value.trim();
    p.attrs=attrs;
    const idx=state.players.findIndex(x=>x.id===p.id);
    if(idx>=0) state.players[idx]=p; else state.players.push(p);
    saveState();render();modal.remove();
  };
  document.body.appendChild(modal);
}
window.editPlayer=(id)=>{const p=state.players.find(x=>x.id===id);if(p) openPlayerModal(p);};
window.deletePlayer=(id)=>{const p=state.players.find(x=>x.id===id);if(!p) return;
  if(!confirm(`Spieler "${p.name}" lÃ¶schen?`)) return;
  state.players=state.players.filter(x=>x.id!==id);
  (state.sessions||[]).forEach(s=>s.attendance=(s.attendance||[]).filter(a=>a.playerId!==id));
  (state.matches||[]).forEach(m=>m.stats=(m.stats||[]).filter(a=>a.playerId!==id));
  saveState();render();
};

// â”€â”€ TRAINING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderSessions(){
  const root=el(`<div class="grid"></div>`);
  const card=el(`<div class="card">
    <div class="controls" style="justify-content:space-between;">
      <h2 style="margin:0;">Trainingseinheiten</h2>
      <div class="controls">
        <button class="btn secondary" id="addThu">âš½ Donnerstag</button>
        <button class="btn" id="add">+ Einheit</button>
      </div>
    </div>
    <div class="sep"></div>
    <div class="notice">Standard-Anwesenheit: nur <b>Stammspieler</b> vorausgewÃ¤hlt.</div>
    <div class="sep"></div>
    <div class="table-wrap">${renderSessionsTable()}</div>
  </div>`);
  card.querySelector("#add").onclick=()=>openSessionModal(null);
  card.querySelector("#addThu").onclick=()=>openSessionModal({
    id:uid(),date:nextThursday(),minutes:90,rpe:6,focus:["passspiel","positioning"],
    attendance:state.players.map(p=>({playerId:p.id,present:p.squadRole==="Stammspieler"})),
    notes:"ASK Erlaa â€“ 20:00â€“21:30"
  });
  root.appendChild(card);return root;
}
function renderSessionsTable(){
  const ss=[...(state.sessions||[])].sort((a,b)=>(b.date||"").localeCompare(a.date||""));
  if(!ss.length) return `<p class="muted">Noch keine Einheiten erfasst.</p>`;
  const stamm=new Set(state.players.filter(p=>p.squadRole==="Stammspieler").map(p=>p.id));
  const tableHtml=`<table><thead><tr><th>Datum</th><th>Dauer</th><th>Schwerpunkt</th><th>RPE</th><th>Stamm</th><th>Aktionen</th></tr></thead><tbody>`+
    ss.map(s=>{
      const pres=(s.attendance||[]).filter(a=>stamm.has(a.playerId)&&a.present).length;
      return `<tr>
        <td class="mono" style="white-space:nowrap">${s.date}</td>
        <td class="mono" style="white-space:nowrap">${s.minutes} min</td>
        <td>${(s.focus||[]).map(f=>`<span class="chip gold">${escapeHtml(f)}</span>`).join("")}</td>
        <td><span class="pill">${s.rpe}</span></td>
        <td class="mono">${pres}/${stamm.size}</td>
        <td><div class="row-actions">
          <button class="btn secondary" onclick="editSession('${s.id}')">âœï¸</button>
          <button class="btn danger" onclick="deleteSession('${s.id}')">ğŸ—‘</button>
        </div></td></tr>`;
    }).join("")+`</tbody></table>`;
  const cardsHtml=`<div class="mobile-card-list">`+ss.map(s=>{
    const pres=(s.attendance||[]).filter(a=>stamm.has(a.playerId)&&a.present).length;
    return `<div style="border:1px solid var(--line);border-radius:14px;padding:12px;margin-bottom:8px;background:rgba(18,18,26,.8);">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:6px;">
        <div>
          <div style="font-weight:700;font-size:14px;">ğŸ“… ${s.date}</div>
          <div class="muted small">${s.minutes} min &nbsp;Â·&nbsp; ğŸ‘¥ ${pres}/${stamm.size} Stamm</div>
        </div>
        <span class="pill" style="font-size:14px;font-weight:900;">${s.rpe}/10</span>
      </div>
      <div style="margin-bottom:8px;">${(s.focus||[]).map(f=>`<span class="chip gold">${escapeHtml(f)}</span>`).join("")||'<span class="muted small">Kein Schwerpunkt</span>'}</div>
      <div class="row-actions">
        <button class="btn secondary" onclick="editSession('${s.id}')">âœï¸ Bearbeiten</button>
        <button class="btn danger" onclick="deleteSession('${s.id}')">ğŸ—‘</button>
      </div>
    </div>`;
  }).join("")+`</div>`;
  return `<div class="mobile-cards">${tableHtml}${cardsHtml}</div>`;
}
function openSessionModal(session){
  const all=state.players;
  const s=session?structuredClone(session):{
    id:uid(),date:new Date().toISOString().slice(0,10),minutes:90,rpe:6,
    focus:["passspiel","positioning"],
    attendance:all.map(p=>({playerId:p.id,present:p.squadRole==="Stammspieler"})),
    notes:""
  };
  // Build all focus options - union of both attr sets
  const allAttrKeys=[...new Set([...ATTRS_FIELD.map(a=>a[0]),...ATTRS_GK.map(a=>a[0])])];
  const allAttrLabels=Object.fromEntries([...ATTRS_FIELD,...ATTRS_GK]);
  const modal=el(`<div class="modal-overlay">
    <div class="modal-sheet wide">
      <div class="controls" style="justify-content:space-between;">
        <h2 style="margin:0;">${session?"Training bearbeiten":"Neue Trainingseinheit"}</h2>
        <button class="btn secondary" id="close">SchlieÃŸen</button>
      </div>
      <div class="inline" style="margin-top:12px;">
        <div><label>Datum</label><input id="date" type="date" value="${s.date}"></div>
        <div><label>Dauer (Minuten)</label><input id="min" type="number" min="30" max="240" step="5" value="${s.minutes}"></div>
      </div>
      <div class="inline">
        <div>
          <label style="display:flex;align-items:center;gap:6px;">
            Belastung â€“ RPE (1â€“10)
            <span class="tooltip-wrap" style="cursor:help;">
              <span style="display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:50%;background:rgba(212,175,55,.2);border:1px solid rgba(212,175,55,.4);font-size:11px;color:var(--gold);font-weight:700;">?</span>
              <span class="tip">
                <b>RPE = Rate of Perceived Exertion</b><br>Empfundene Belastung 1â€“10:<br>
                1â€“2: sehr leicht (AufwÃ¤rmen)<br>
                3â€“4: locker (Technik, PÃ¤sse)<br>
                5â€“6: mittel (normales Training)<br>
                7â€“8: intensiv (Intervall, Spiele)<br>
                9â€“10: maximale Belastung<br><br>
                <i>Beeinflusst Attribut-Steigerung nach Training.</i>
              </span>
            </span>
          </label>
          <input id="rpe" type="number" min="1" max="10" step="1" value="${s.rpe}">
        </div>
        <div><label>Schwerpunkt-Preset</label>
          <select id="preset">
            <option value="">(frei wÃ¤hlen)</option>
            ${Object.keys(FOCUS_PRESETS).map(k=>`<option value="${escapeAttr(k)}">${escapeHtml(k)}</option>`).join("")}
          </select>
        </div>
      </div>
      <label>Schwerpunkte (beliebig viele wÃ¤hlbar)</label>
      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:6px;margin-top:6px;" id="focusBtns">
        ${allAttrKeys.map(k=>`<button type="button" class="tab ${s.focus.includes(k)?"active":""}" data-fk="${k}" style="border-radius:10px;text-align:left;font-size:12px;">${allAttrLabels[k]||k}</button>`).join("")}
      </div>
      <div class="sep"></div>
      <div class="controls" style="justify-content:space-between;">
        <div><h2 style="margin:0;">Anwesenheit</h2><div class="muted small">Standard: Stammspieler = Ja</div></div>
        <div class="controls">
          <button class="btn secondary" id="bStamm">Nur Stamm</button>
          <button class="btn secondary" id="bAll">Alle</button>
          <button class="btn secondary" id="bNone">Keine</button>
        </div>
      </div>
      <div class="sep"></div>
      <div style="max-height:280px;overflow-y:auto;overflow-x:auto;-webkit-overflow-scrolling:touch;">
        <table><thead><tr><th>Spieler</th><th>Position</th><th>Status</th><th>Anwesend</th></tr></thead><tbody>
        ${all.slice().sort((a,b)=>a.name.localeCompare(b.name)).map(p=>{
          const a=(s.attendance||[]).find(x=>x.playerId===p.id)||{present:false};
          return `<tr><td><b>${p.name}</b> <span class="pill">#${p.number??""}</span></td>
            <td><span class="chip">${posLabel(p.position)}</span></td>
            <td>${p.squadRole==="Stammspieler"?'<span class="chip gold">Stamm</span>':'<span class="chip">Joker</span>'}</td>
            <td><select data-att="${p.id}">
              <option value="yes" ${a.present?"selected":""}>Ja</option>
              <option value="no" ${a.present?"":"selected"}>Nein</option>
            </select></td></tr>`;
        }).join("")}
        </tbody></table>
      </div>
      <label>Notizen</label><textarea id="notes">${escapeHtml(s.notes||"")}</textarea>
      <div class="sep"></div>
      <div class="controls" style="justify-content:flex-end;">
        <button class="btn" id="save">Speichern & Fortschritt anwenden</button>
      </div>
    </div></div>`);
  modal.querySelector("#close").onclick=()=>modal.remove();
  // Focus toggle buttons
  modal.querySelector("#focusBtns").querySelectorAll("[data-fk]").forEach(b=>{
    b.onclick=()=>{
      const k=b.getAttribute("data-fk");
      const active=b.classList.contains("active");
      const cur=[...modal.querySelector("#focusBtns").querySelectorAll(".active")];
      if(!active && cur.length>=3) return alert(" Schwerpunkte.");
      b.classList.toggle("active",!active);
    };
  });
  // Preset
  modal.querySelector("#preset").onchange=(e)=>{
    const keys=FOCUS_PRESETS[e.target.value]||[];
    modal.querySelector("#focusBtns").querySelectorAll("[data-fk]").forEach(b=>{
      b.classList.toggle("active",keys.includes(b.getAttribute("data-fk")));
    });
  };
  // attendance bulk
  function setAtt(mode){
    modal.querySelectorAll("[data-att]").forEach(sel=>{
      const pid=sel.getAttribute("data-att");const p=state.players.find(x=>x.id===pid);
      if(mode==="stamm") sel.value=(p&&p.squadRole==="Stammspieler")?"yes":"no";
      if(mode==="all") sel.value="yes";if(mode==="none") sel.value="no";
    });
  }
  modal.querySelector("#bStamm").onclick=()=>setAtt("stamm");
  modal.querySelector("#bAll").onclick=()=>setAtt("all");
  modal.querySelector("#bNone").onclick=()=>setAtt("none");
  modal.querySelector("#save").onclick=()=>{
    s.date=modal.querySelector("#date").value;
    s.minutes=parseInt(modal.querySelector("#min").value,10)||90;
    s.rpe=clamp(parseInt(modal.querySelector("#rpe").value,10)||6,1,10);
    s.notes=modal.querySelector("#notes").value.trim();
    s.focus=[...modal.querySelector("#focusBtns").querySelectorAll(".active")].map(b=>b.getAttribute("data-fk"));
    s.attendance=[];
    modal.querySelectorAll("[data-att]").forEach(sel=>{s.attendance.push({playerId:sel.getAttribute("data-att"),present:sel.value==="yes"});});
    const idx=state.sessions.findIndex(x=>x.id===s.id);const isEdit=idx>=0;
    if(isEdit){
      if(confirm("Training erneut speichern â€“ Fortschritt erneut anwenden?")) {state.sessions[idx]=s;applyProgress(s);}
      else state.sessions[idx]=s;
    } else {state.sessions.push(s);applyProgress(s);}
    saveState();render();modal.remove();
  };
  document.body.appendChild(modal);
}
function applyProgress(s){
  const present=new Set((s.attendance||[]).filter(a=>a.present).map(a=>a.playerId));
  const base=state.settings.baseGain||0.2;
  const rpe=(s.rpe||6)*(state.settings.rpeMultiplier||0.04);
  const maxG=state.settings.maxGain||0.6;const minG=state.settings.minGain||0.05;
  (state.players||[]).forEach(p=>{
    if(!present.has(p.id)) return;
    const attrKeys=getAttrs(p.position).map(a=>a[0]);
    (s.focus||[]).forEach(k=>{
      if(attrKeys.includes(k)){
        const g=clamp(base+rpe,minG,maxG);
        p.attrs[k]=round1(clamp((p.attrs[k]||10)+g,1,20));
      }
    });
    const fg=clamp((base/2)+(rpe/2),minG,maxG/2);
    if(attrKeys.includes("fitness")) p.attrs.fitness=round1(clamp((p.attrs.fitness||10)+fg,1,20));
    if((s.minutes||90)>=80 && attrKeys.includes("ausdauer")) p.attrs.ausdauer=round1(clamp((p.attrs.ausdauer||10)+clamp(0.10+(rpe/4),0.05,0.25),1,20));
    p.history=p.history||[];
    p.history.push({date:s.date,attrs:structuredClone(p.attrs)});
    if(p.history.length>120) p.history=p.history.slice(p.history.length-120);
  });
}
window.editSession=(id)=>{const s=state.sessions.find(x=>x.id===id);if(s) openSessionModal(s);};
window.deleteSession=(id)=>{const s=state.sessions.find(x=>x.id===id);if(!s) return;
  if(!confirm(`Training am ${s.date} lÃ¶schen?`)) return;
  state.sessions=state.sessions.filter(x=>x.id!==id);saveState();render();};

// â”€â”€ ENTWICKLUNG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function svgLineChart(points,keys,W=760,H=260){
  if(!points||!points.length) return `<p class="muted">Noch keine Historie. Tipp: Nach jedem Training wird ein Snapshot gespeichert.</p>`;
  const pad=32;const minY=1;const maxY=20;
  const xStep=(W-2*pad)/Math.max(1,points.length-1);
  function yc(v){return(H-pad)-((v-minY)/(maxY-minY))*(H-2*pad);}
  function xc(i){return pad+i*xStep;}
  const grid=[];
  for(let v=5;v<=20;v+=5){
    grid.push(`<line x1="${pad}" y1="${yc(v)}" x2="${W-pad}" y2="${yc(v)}" stroke="rgba(255,255,255,.08)"/>`);
    grid.push(`<text x="${pad-6}" y="${yc(v)+4}" fill="rgba(255,255,255,.38)" font-size="10" text-anchor="end">${v}</text>`);
  }
  const colors=["rgba(212,175,55,.9)","rgba(90,140,255,.85)","rgba(87,227,137,.85)","rgba(255,90,106,.85)"];
  const paths=keys.map((k,i)=>{
    const d=points.map((p,j)=>`${j===0?"M":"L"} ${xc(j)} ${yc(p.attrs?.[k]??0)}`).join(" ");
    return `<path d="${d}" fill="none" stroke="${colors[i%4]}" stroke-width="2.5"/>`;
  }).join("");
  const dots=keys.map((k,i)=>points.map((p,j)=>`<circle cx="${xc(j)}" cy="${yc(p.attrs?.[k]??0)}" r="2.6" fill="${colors[i%4]}"/>`).join("")).join("");
  const xLabels=points.map((p,i)=>{
    if(points.length>10&&i%2===1) return "";
    return `<text x="${xc(i)}" y="${H-8}" fill="rgba(255,255,255,.38)" font-size="10" text-anchor="middle">${(p.date||"").slice(5)}</text>`;
  }).join("");
  const legend=keys.map((k,i)=>`<span class="chip gold" style="border-color:${colors[i%4]}">${escapeHtml(k)}</span>`).join("");
  return `<div style="margin-bottom:8px;">${legend}</div>
    <svg viewBox="0 0 ${W} ${H}" width="100%" height="${H}" style="background:rgba(10,10,14,.35);border:1px solid var(--line);border-radius:16px;">
      ${grid.join("")}${paths}${dots}${xLabels}
    </svg>`;
}
function buildTeamHistory(filterFn){
  const map=new Map();
  (state.players||[]).forEach(p=>{
    if(filterFn&&!filterFn(p)) return;
    (p.history||[]).forEach(h=>{
      const date=h.date||"";if(!date) return;
      if(!map.has(date)) map.set(date,{sum:{},n:0});
      const e=map.get(date);
      [...ATTRS_FIELD,...ATTRS_GK].forEach(([k])=>{e.sum[k]=(e.sum[k]||0)+(h.attrs?.[k]??0);});
      e.n+=1;
    });
  });
  return [...map.keys()].sort().map(d=>{
    const e=map.get(d);const attrs={};
    [...ATTRS_FIELD,...ATTRS_GK].forEach(([k])=>{attrs[k]=e.n?(e.sum[k]/e.n):0;});
    return{date:d,attrs};
  });
}
function renderDevelopment(){
  const root=el(`<div class="grid"></div>`);
  const players=state.players||[];
  const card=el(`<div class="card">
    <div class="controls" style="justify-content:space-between;">
      <h2 style="margin:0;">Spieler-Entwicklung</h2>
      <button class="btn secondary" id="snapshot">ğŸ“¸ Snapshot speichern</button>
    </div>
    <div class="sep"></div>
    <div class="row two">
      <div>
        <label>Ansicht</label>
        <select id="viewPick">
          <option value="player">Einzelspieler</option>
          <option value="team_core">Team-Trend (Stamm)</option>
          <option value="team_all">Team-Trend (alle)</option>
        </select>
        <div class="sep"></div>
        <label>Spieler auswÃ¤hlen</label>
        <select id="playerPick"></select>
        <label>Attribute anzeigen (max. 4)</label>
        <div id="attrPick" style="display:flex;flex-wrap:wrap;gap:5px;margin-top:6px;"></div>
        <div class="sep"></div>
        <div class="notice small">Snapshots werden automatisch nach jedem Training gespeichert.</div>
      </div>
      <div>
        <h2>Entwicklungskurve</h2>
        <div id="chart"></div>
        <div class="sep"></div>
        <h2>Verlauf (letzte 20)</h2>
        <div class="table-wrap" id="histTable"></div>
      </div>
    </div>
  </div>`);
  root.appendChild(card);

  // Populate player select
  const pick=card.querySelector("#playerPick");
  players.sort((a,b)=>a.name.localeCompare(b.name)).forEach(p=>{
    const o=document.createElement("option");
    o.value=p.id;o.textContent=`#${p.number} ${p.name} (${posLabel(p.position)})`;
    pick.appendChild(o);
  });

  const defaultKeys=["passspiel","positioning","ausdauer","fitness"];
  let selKeys=new Set(defaultKeys);

  function renderAttrToggles(){
    const p=getPlayer();const attrList=p?getAttrs(p.position):[...ATTRS_FIELD];
    const box=card.querySelector("#attrPick");
    box.innerHTML=attrList.map(([k,l])=>`<button type="button" class="tab ${selKeys.has(k)?"active":""}" data-ak="${k}" style="font-size:11px;padding:5px 9px;">${l}</button>`).join("");
    box.querySelectorAll("[data-ak]").forEach(b=>{
      b.onclick=()=>{
        const k=b.getAttribute("data-ak");
        if(selKeys.has(k)){if(selKeys.size<=1) return;selKeys.delete(k);}
        else{if(selKeys.size>=4) return alert("Max. 4 Attribute.");selKeys.add(k);}
        update();
      };
    });
  }
  function getPlayer(){
    const id=card.querySelector("#playerPick").value;
    return state.players.find(p=>p.id===id)||state.players[0];
  }
  function update(){
    renderAttrToggles();
    const view=card.querySelector("#viewPick").value;
    const keys=[...selKeys];
    let hist=[];
    if(view==="player"){
      const p=getPlayer();
      if(p) hist=(p.history||[]).slice().sort((a,b)=>(a.date||"").localeCompare(b.date||""));
    } else if(view==="team_core"){
      hist=buildTeamHistory(p=>p.squadRole==="Stammspieler");
    } else {
      hist=buildTeamHistory(null);
    }
    card.querySelector("#chart").innerHTML=svgLineChart(hist,keys,760,260);
    if(!hist.length){card.querySelector("#histTable").innerHTML=`<p class="muted">Keine Daten.</p>`;return;}
    const rows=hist.slice(-20).reverse().map(h=>{
      const cols=keys.map(k=>`<td class="mono">${round1(h.attrs?.[k]??0)}</td>`).join("");
      return `<tr><td class="mono">${h.date||""}</td>${cols}</tr>`;
    }).join("");
    card.querySelector("#histTable").innerHTML=`<table>
      <thead><tr><th>Datum</th>${keys.map(k=>`<th>${escapeHtml(k)}</th>`).join("")}</tr></thead>
      <tbody>${rows}</tbody></table>`;
  }
  card.querySelector("#playerPick").onchange=update;
  card.querySelector("#viewPick").onchange=()=>{
    const v=card.querySelector("#viewPick").value;
    card.querySelector("#playerPick").disabled=(v!=="player");
    update();
  };
  card.querySelector("#snapshot").onclick=()=>{
    if(card.querySelector("#viewPick").value!=="player") return alert("Snapshot nur fÃ¼r Einzelspieler.");
    const p=getPlayer();if(!p) return;
    p.history=p.history||[];
    p.history.push({date:new Date().toISOString().slice(0,10),attrs:structuredClone(p.attrs)});
    if(p.history.length>120) p.history=p.history.slice(-120);
    saveState();update();alert("Snapshot gespeichert âœ…");
  };
  update();return root;
}

// â”€â”€ MATCHPLANNER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function formationSlots(fmt,formation){
  const slots=[];
  slots.push({key:"GK",label:"TW",hint:"Torwart"});
  const add=(k,l,h)=>slots.push({key:k,label:l,hint:h||""});
  if(fmt==="5+1"){
    if(formation==="2-2-1"){
      add("D1","IV-L","Sicherheits-IV");add("D2","IV-R","Spielaufbauender IV");
      add("M1","ZM-L","LÃ¤ufer");add("M2","ZM-R","Spielmacher");
      add("S1","ST","Zielspieler");
    } else if(formation==="1-2-2"){
      add("D1","IV","Anker-IV");
      add("M1","ZM-L","LÃ¤ufer");add("M2","ZM-R","Spielmacher");
      add("S1","LA","AuÃŸenstÃ¼rmer");add("S2","RA","Finisher");
    } else {
      add("D1","IV-L","Sicherheits-IV");add("D2","IV-R","Spielaufbauender IV");
      add("M1","ZM","Anker/Spielmacher");
      add("S1","LA","AuÃŸenstÃ¼rmer");add("S2","RA","Finisher");
    }
  } else {
    if(formation==="3-2-1"){
      add("D1","IV-L","Sicherheits-IV");add("D2","IV-M","Anker");add("D3","IV-R","Spielaufbauender IV");
      add("M1","ZM-L","LÃ¤ufer");add("M2","ZM-R","Spielmacher");
      add("S1","ST","Zielspieler");
    } else {
      add("D1","IV-L","Sicherheits-IV");add("D2","IV-R","Spielaufbauender IV");
      add("M1","ZM-L","LÃ¤ufer");add("M2","ZM-M","Anker");add("M3","ZM-R","Spielmacher");
      add("S1","ST","Zielspieler");
    }
  }
  return slots;
}
function upcomingGames(){
  const now=new Date();
  return (state.schedule||[]).map(g=>({...g,dt:new Date(g.date+"T"+(g.time||"00:00")+":00")}))
    .sort((a,b)=>a.dt-b.dt).filter(g=>g.dt>=new Date(now.getTime()-86400000));
}
function renderPlanner(){
  const root=el(`<div class="grid"></div>`);
  const games=upcomingGames();
  const defaultGame=games[0]||(state.schedule||[])[0]||{date:"",time:"",opponent:"",home:true,location:""};
  state.matchPlans=state.matchPlans||[];
  const existing=state.matchPlans.find(p=>p.game?.date===defaultGame.date&&p.game?.time===defaultGame.time)||null;
  const card=el(`<div class="card">
    <div class="controls" style="justify-content:space-between;">
      <h2 style="margin:0;">Matchplanner</h2>
      <div class="controls">
        <span class="tooltip-wrap">
          <button class="btn secondary" id="copyPlan">ğŸ“‹ WhatsApp Matchplan</button>
          <span class="tip" style="min-width:280px;white-space:normal;">Erstellt einen fertigen WhatsApp-Text mit: Spielinfo, Treffpunkt, Aufstellung (nach Position), Bank, Regeln &amp; Coach Notes. Einfach kopieren und in den Gruppen-Chat einfÃ¼gen.</span>
        </span>
        <button class="btn secondary" id="exportImg">ğŸ–¼ Als Bild exportieren</button>
        <button class="btn" id="savePlan">ğŸ’¾ Speichern</button>
      </div>
    </div>
    <div class="sep"></div>
    <div class="row two">
      <div>
        <h2>Spiel & Einstellungen</h2>
        <label>Spiel auswÃ¤hlen</label>
        <select id="gamePick">
          ${(games.length?games:state.schedule||[]).map((g,i)=>{
            const txt=`${g.date} ${g.time} â€“ ${g.home?"BU vs. "+g.opponent:g.opponent+" vs. BU"}`;
            return `<option value="${i}">${escapeHtml(txt)}</option>`;
          }).join("")}
        </select>
        <div class="inline" style="margin-top:10px;">
          <div><label>Format</label>
            <select id="format"><option value="5+1">5+1</option><option value="6+1">6+1</option></select>
          </div>
          <div><label>Formation</label>
            <select id="formation">
              <option value="2-2-1">2-2-1 (stabil)</option>
              <option value="1-2-2">1-2-2 (mehr Angriff)</option>
              <option value="2-1-2">2-1-2 (direkt)</option>
              <option value="3-2-1">3-2-1 (6+1 stabil)</option>
              <option value="2-3-1">2-3-1 (6+1 Kontrolle)</option>
            </select>
          </div>
        </div>
        <label>Treffpunkt (Minuten vor AnstoÃŸ)</label>
        <input id="meet" type="number" min="15" max="90" step="5" value="45"/>
        <label>SchlÃ¼ssel-Regeln (jede Zeile eine Regel)</label>
        <textarea id="rules" placeholder="z.B.: Ball > Gegner"></textarea>
        <label>Coach Notes</label>
        <textarea id="notes" placeholder="Taktische Hinweiseâ€¦"></textarea>
        <div class="sep"></div>
        <h2>Matchday Checkliste <span style="font-size:11px;color:var(--muted);text-transform:none;font-weight:400;">(bearbeitbar)</span></h2>
        <textarea id="check" style="min-height:140px;font-size:13px;line-height:1.7;font-family:var(--mono);width:100%;"></textarea>
        <div style="margin-top:8px;display:flex;gap:8px;">
          <button class="btn secondary" id="copyCheck">ğŸ“‹ Kopieren</button>
          <button class="btn secondary" id="resetCheck">ğŸ”„ ZurÃ¼cksetzen</button>
        </div>
        <div class="sep"></div>
        <h2>VerfÃ¼gbarkeit</h2>
        <div class="notice small" style="margin-bottom:8px;">Stamm=âœ…, Joker=â³ (anpassbar)</div>
        <div style="max-height:260px;overflow-y:auto;overflow-x:auto;-webkit-overflow-scrolling:touch;">
          <table><thead><tr><th>Spieler</th><th>Status</th><th>VerfÃ¼gbar</th></tr></thead>
          <tbody id="availRows"></tbody></table>
        </div>
      </div>
      <div>
        <h2>Aufstellung</h2>
        <div class="notice small" style="margin-bottom:8px;">Drag & Drop: Spieler in Slots ziehen. Doppelklick auf Slot = entfernen.</div>
        <div class="slotGrid">
          <div class="pitch">
            <div class="controls" style="justify-content:space-between;margin-bottom:8px;">
              <span class="muted small" id="slotInfo"></span>
              <div class="controls">
                <button class="btn secondary" id="auto">Auto-Aufstellung</button>
                <button class="btn secondary" id="clear">Leeren</button>
              </div>
            </div>
            <div id="slots"></div>
            <div class="sep"></div>
            <h2>Bank</h2>
            <div id="bench" class="muted small"></div>
          </div>
          <div class="pitch">
            <h2>Spieler-Pool</h2>
            <label>Anzeige</label>
            <select id="poolMode">
              <option value="all">Alle</option>
              <option value="core">Nur Stamm</option>
              <option value="availableOnly">Nur âœ… dabei</option>
            </select>
            <div class="sep"></div>
            <div id="pool"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="sep"></div>
    <!-- Hidden canvas for image export -->
    <canvas id="exportCanvas" style="display:none;"></canvas>
  </div>`);
  root.appendChild(card);

  const plan=structuredClone(existing||{
    id:"mp_"+uid(),game:structuredClone(defaultGame),
    format:"5+1",formation:"2-2-1",meetMins:45,
    keyRules:["Ball > Gegner","Kein Dribbling hinten","Nach Ballverlust: 3 Sek. Druck","Reden!","Position halten > Ball jagen"],
    notes:"",lineup:[],bench:[],availability:{}
  });

  function setDefaultAvail(){
    (state.players||[]).forEach(p=>{if(!plan.availability[p.id]) plan.availability[p.id]=(p.squadRole==="Stammspieler")?"yes":"maybe";});
  }
  function listGames(){return(games.length?games:state.schedule||[]);}
  function currentGame(){const i=parseInt(card.querySelector("#gamePick").value,10)||0;return structuredClone(listGames()[i]||defaultGame);}
  function slotAssigned(k){return plan.lineup.find(x=>x.slotKey===k)||null;}
  function playerAssigned(pid){return plan.lineup.find(x=>x.playerId===pid)||null;}
  function slotsList(){return formationSlots(card.querySelector("#format").value,card.querySelector("#formation").value);}

  function checklistText(){
    const g=plan.game;
    return [`âœ… *MATCHDAY CHECKLISTE*`,
      `ğŸ“ Ort: ${g.location||""}`,`â° Treffpunkt: ${plan.meetMins||45} Min vor AnstoÃŸ`,
      `ğŸªª Ausweis + ğŸŸ¨ğŸ–¤ Trikot`,`ğŸ’§ Wasser / Iso`,`ğŸ©¹ Schienbeinschoner / Tape`,
      `ğŸ§¤ (bei KÃ¤lte) Handschuhe/MÃ¼tze`,`ğŸ“£ Kommunikation & Rollen klÃ¤ren`].join("\n");
  }

  function renderChecklist(){
    const ta=card.querySelector("#check");
    if(!ta.value) ta.value=checklistText();
  }
  function resetChecklist(){card.querySelector("#check").value=checklistText();}

  function renderAvailability(){
    setDefaultAvail();
    const body=card.querySelector("#availRows");
    body.innerHTML=(state.players||[]).slice().sort((a,b)=>a.name.localeCompare(b.name)).map(p=>{
      const v=plan.availability[p.id]||"maybe";
      return `<tr><td><b>${escapeHtml(p.name)}</b> <span class="pill">#${p.number??""}</span></td>
        <td>${p.squadRole==="Stammspieler"?'<span class="chip gold">Stamm</span>':'<span class="chip">Joker</span>'}</td>
        <td><select data-av="${p.id}">
          <option value="yes" ${v==="yes"?"selected":""}>âœ… dabei</option>
          <option value="maybe" ${v==="maybe"?"selected":""}>â³ vielleicht</option>
          <option value="no" ${v==="no"?"selected":""}>âŒ nein</option>
        </select></td></tr>`;
    }).join("");
    body.querySelectorAll("[data-av]").forEach(sel=>{
      sel.onchange=()=>{plan.availability[sel.getAttribute("data-av")]=sel.value;renderPool();renderBench();};
    });
  }

  function poolPlayers(){
    const mode=card.querySelector("#poolMode").value;
    const ps=state.players||[];
    if(mode==="core") return ps.filter(p=>p.squadRole==="Stammspieler");
    if(mode==="availableOnly") return ps.filter(p=>(plan.availability[p.id]||"maybe")==="yes");
    return ps;
  }

  function renderSlots(){
    const slots=slotsList();
    card.querySelector("#slotInfo").innerText=`${slots.length} PlÃ¤tze Â· ${card.querySelector("#format").value} Â· ${card.querySelector("#formation").value}`;
    card.querySelector("#slots").innerHTML=slots.map(s=>{
      const a=slotAssigned(s.key);
      return `<div class="slot" data-slot="${s.key}">
        <div><strong>${escapeHtml(s.label)}</strong><div class="muted small">${escapeHtml(s.hint)}</div></div>
        <div style="flex:1;margin:0 8px;">
          <div class="muted small">${a?`<b style="color:var(--text);">${escapeHtml(a.name)}</b>`:"<i>leer â€“ Spieler ziehen</i>"}</div>
          <input class="small" data-role="${s.key}" placeholder="Rolle (optional)" value="${escapeAttr(a?.role||"")}" style="margin-top:4px;"/>
        </div>
      </div>`;
    }).join("");
    card.querySelector("#slots").querySelectorAll("[data-slot]").forEach(slot=>{
      slot.ondragover=e=>e.preventDefault();
      slot.ondrop=e=>{e.preventDefault();const pid=e.dataTransfer.getData("text/playerId");if(pid) assignToSlot(pid,slot.getAttribute("data-slot"));};
      slot.ondblclick=()=>{plan.lineup=plan.lineup.filter(x=>x.slotKey!==slot.getAttribute("data-slot"));renderSlots();renderBench();renderPool();};
    });
    card.querySelector("#slots").querySelectorAll("[data-role]").forEach(inp=>{
      inp.oninput=()=>{const a=slotAssigned(inp.getAttribute("data-role"));if(a) a.role=inp.value.trim();};
    });
  }

  function renderBench(){
    const sel=new Set(plan.lineup.map(x=>x.playerId));
    const bench=poolPlayers().filter(p=>!sel.has(p.id)).map(p=>p.name);
    plan.bench=bench.map(n=>({name:n}));
    card.querySelector("#bench").innerText=bench.length?bench.join(", "):"â€”";
  }

  function renderPool(){
    const pool=poolPlayers().slice().sort((a,b)=>{
      const sc=p=>({yes:0,maybe:1,no:2}[plan.availability[p.id]||"maybe"]);
      const s=sc(a)-sc(b);if(s!==0) return s;
      const ar=a.squadRole==="Stammspieler"?0:1,br=b.squadRole==="Stammspieler"?0:1;
      if(ar!==br) return ar-br;
      const pr={TW:0,IV:1,DM:2,ZM:3,OM:4,LA:5,RA:5,ST:6};
      return (pr[a.position]??9)-(pr[b.position]??9);
    });
    const sel=new Set(plan.lineup.map(x=>x.playerId));
    card.querySelector("#pool").innerHTML=pool.map(p=>{
      const v=plan.availability[p.id]||"maybe";
      const badge=v==="yes"?"âœ…":(v==="no"?"âŒ":"â³");
      const assigned=sel.has(p.id);
      return `<div class="draggable" draggable="${assigned?"false":"true"}" data-player="${p.id}" style="opacity:${assigned?.45:1}">
        <div class="controls" style="justify-content:space-between;">
          <div><b>${badge} ${escapeHtml(p.name)}</b> <span class="pill">#${p.number??""}</span></div>
          <div class="kv">
            ${p.squadRole==="Stammspieler"?'<span class="chip gold">Stamm</span>':'<span class="chip">Joker</span>'}
            <span class="chip">${posLabel(p.position)}</span>
          </div>
        </div>
        <div class="muted small">${escapeHtml(p.role||"")}</div>
      </div>`;
    }).join("");
    card.querySelector("#pool").querySelectorAll("[data-player]").forEach(div=>{
      div.ondragstart=e=>e.dataTransfer.setData("text/playerId",div.getAttribute("data-player"));
      div.ondblclick=()=>{
        const pid=div.getAttribute("data-player");
        const slots=slotsList();const free=slots.find(s=>!slotAssigned(s.key));
        if(!free) return alert("Keine freien Slots.");
        assignToSlot(pid,free.key);
      };
    });
  }

  function assignToSlot(pid,slotKey){
    if((plan.availability[pid]||"maybe")==="no" && !confirm("Spieler ist auf âŒ. Trotzdem aufstellen?")) return;
    plan.lineup=plan.lineup.filter(x=>x.playerId!==pid);
    plan.lineup=plan.lineup.filter(x=>x.slotKey!==slotKey);
    const p=state.players.find(x=>x.id===pid);
    plan.lineup.push({slotKey,playerId:pid,name:p?.name||"Spieler",role:""});
    renderSlots();renderBench();renderPool();
  }

  function autoLineup(){
    plan.lineup=[];
    const slots=slotsList();
    const pool=poolPlayers().filter(p=>(plan.availability[p.id]||"maybe")!=="no")
      .sort((a,b)=>{const ar=a.squadRole==="Stammspieler"?0:1,br=b.squadRole==="Stammspieler"?0:1;return ar-br;});
    function pick(want){
      const idx=pool.findIndex(p=>!playerAssigned(p.id)&&p.position===want);
      if(idx>=0) return pool[idx];
      const j=pool.findIndex(p=>!playerAssigned(p.id));
      return j>=0?pool[j]:null;
    }
    slots.forEach(s=>{
      let want="ZM";
      if(s.label.startsWith("TW")) want="TW";
      else if(s.label.includes("IV")) want="IV";
      else if(s.label.includes("ST")) want="ST";
      const p=pick(want);
      if(p) plan.lineup.push({slotKey:s.key,playerId:p.id,name:p.name,role:s.hint||""});
    });
    renderSlots();renderBench();renderPool();
  }

  function syncFromUI(){
    plan.game=currentGame();
    plan.format=card.querySelector("#format").value;
    plan.formation=card.querySelector("#formation").value;
    plan.meetMins=parseInt(card.querySelector("#meet").value,10)||45;
    plan.keyRules=card.querySelector("#rules").value.split("\n").map(x=>x.trim()).filter(Boolean).slice(0,8);
    plan.notes=card.querySelector("#notes").value.trim();
    card.querySelectorAll("[data-role]").forEach(inp=>{
      const a=slotAssigned(inp.getAttribute("data-role"));if(a) a.role=inp.value.trim();
    });
    renderBench();
  }

  function savePlan(){
    syncFromUI();
    const idx=state.matchPlans.findIndex(p=>p.id===plan.id);
    if(idx>=0) state.matchPlans[idx]=structuredClone(plan);
    else state.matchPlans.push(structuredClone(plan));
    saveState();
  }

  function buildPollText(){
    const g=plan.game;
    return [`ğŸŸ¨ğŸ–¤ *Ballers United â€“ VerfÃ¼gbarkeit*`,
      `ğŸ“… ${g.date} Â· ${g.time} Â· ğŸ“ ${g.location||""}`,
      `ğŸ†š ${g.home?`Ballers United vs. ${g.opponent}`:`${g.opponent} vs. Ballers United`}`,
      ``,`Bitte reagieren: âœ… dabei / â³ vielleicht / âŒ nein`].join("\n");
  }

  function buildMatchplanText(){
    const g=plan.game;
    const slots=slotsList();
    const lineup=slots.map(s=>{const a=slotAssigned(s.key);return a?{pos:s.label,name:a.name,role:a.role||s.hint||""}:null;}).filter(Boolean);
    const lines=[
      `ğŸŸ¨ğŸ–¤ *BALLERS UNITED â€“ MATCHPLAN*`,
      `ğŸ“… ${g.date} Â· ${g.time} Â· ğŸ“ ${g.location||""}`,
      `ğŸ†š ${g.home?`Ballers United vs. ${g.opponent}`:`${g.opponent} vs. Ballers United`}`,``,
      `â° *Treffpunkt:* ${plan.meetMins||45} Min vor AnstoÃŸ`,
      `ğŸ’ *Mitbringen:* Trikot + Ausweis (+ Wasser)`,``,
      `ğŸ“Œ *Aufstellung (${plan.format||"5+1"} / ${plan.formation||"2-2-1"}):*`
    ];
    lineup.forEach(p=>lines.push(`â€¢ ${p.pos} â€“ ${p.name}${p.role?` (${p.role})`:""}`));
    if(plan.bench?.length) lines.push(`\nğŸ” *Bank:* ${plan.bench.map(x=>x.name).join(", ")}`);
    if(plan.keyRules?.length){lines.push(`\nâœ… *Fokus/Regeln:*`);plan.keyRules.forEach(r=>lines.push(`â€¢ ${r}`));}
    if(plan.notes) lines.push(`\nğŸ“ *Coach Notes:* ${plan.notes}`);
    return lines.join("\n");
  }

  // â”€â”€ BILD-EXPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function exportLineupImage(){
    savePlan();
    const slots=slotsList();
    const lineup=slots.map(s=>({...s,assigned:slotAssigned(s.key)||null}));
    const g=plan.game;

    const W=480,H=720;
    const canvas=card.querySelector("#exportCanvas");
    canvas.width=W;canvas.height=H;
    const ctx=canvas.getContext("2d");

    // Background â€“ dark
    ctx.fillStyle="#0b0b0f";ctx.fillRect(0,0,W,H);

    // Pitch
    const pitchX=20,pitchY=100,pitchW=W-40,pitchH=H-180;
    const pitchGrad=ctx.createLinearGradient(pitchX,pitchY,pitchX,pitchY+pitchH);
    pitchGrad.addColorStop(0,"#1a3d1a");pitchGrad.addColorStop(0.5,"#1e4820");pitchGrad.addColorStop(1,"#163814");
    ctx.fillStyle=pitchGrad; ctx.fillRect(pitchX,pitchY,pitchW,pitchH);
    // pitch border
    ctx.strokeStyle="rgba(255,255,255,0.3)";ctx.lineWidth=2;
    ctx.strokeRect(pitchX+4,pitchY+4,pitchW-8,pitchH-8);
    // center line
    const cy=pitchY+pitchH/2;
    ctx.beginPath();ctx.moveTo(pitchX+4,cy);ctx.lineTo(pitchX+pitchW-4,cy);ctx.stroke();
    // center circle
    ctx.beginPath();ctx.arc(pitchX+pitchW/2,cy,32,0,Math.PI*2);ctx.stroke();
    // center dot
    ctx.fillStyle="rgba(255,255,255,0.4)";ctx.beginPath();ctx.arc(pitchX+pitchW/2,cy,3,0,Math.PI*2);ctx.fill();
    // penalty areas
    const paW=Math.round(pitchW*0.55),paH=52;
    ctx.strokeStyle="rgba(255,255,255,0.3)";ctx.lineWidth=1.5;
    ctx.strokeRect(pitchX+(pitchW-paW)/2,pitchY+4,paW,paH);
    ctx.strokeRect(pitchX+(pitchW-paW)/2,pitchY+pitchH-paH-4,paW,paH);
    // goal
    const gW=Math.round(pitchW*0.28),gH=18;
    ctx.strokeRect(pitchX+(pitchW-gW)/2,pitchY+4,gW,gH);
    ctx.strokeRect(pitchX+(pitchW-gW)/2,pitchY+pitchH-gH-4,gW,gH);

    // Header
    ctx.fillStyle="#d4af37";ctx.font="bold 16px 'Montserrat',sans-serif";ctx.textAlign="center";
    ctx.fillText("ğŸŸ¨ğŸ–¤  BALLERS UNITED",W/2,28);
    ctx.fillStyle="rgba(255,255,255,0.7)";ctx.font="12px 'Montserrat',sans-serif";
    const matchTxt=g.home?`BU vs. ${g.opponent}`:`${g.opponent} vs. BU`;
    ctx.fillText(`${g.date} Â· ${g.time} Â· ${matchTxt}`,W/2,46);
    ctx.fillText(`${plan.format||"5+1"} / ${plan.formation||"2-2-1"} Â· Treffpunkt: ${plan.meetMins||45}' vor AnstoÃŸ`,W/2,62);
    ctx.fillText(`ğŸ“ ${g.location||""}`,W/2,78);

    // Render players as tokens on pitch
    // Position mapping: divide pitch into rows based on formation
    function getTokenPositions(){
      const positions=[];
      const pH=pitchH-20;
      const pX=pitchX+pitchW/2;
      const pTop=pitchY+15;
      if(plan.format==="5+1"&&plan.formation==="2-2-1"){
        // GK at bottom, 2 DF, 2 MF, 1 ST at top
        positions.push({x:pX,y:pTop+pH*0.88});
        positions.push({x:pX-70,y:pTop+pH*0.65},{x:pX+70,y:pTop+pH*0.65});
        positions.push({x:pX-70,y:pTop+pH*0.38},{x:pX+70,y:pTop+pH*0.38});
        positions.push({x:pX,y:pTop+pH*0.12});
      } else if(plan.format==="5+1"&&plan.formation==="1-2-2"){
        positions.push({x:pX,y:pTop+pH*0.88});
        positions.push({x:pX,y:pTop+pH*0.65});
        positions.push({x:pX-70,y:pTop+pH*0.40},{x:pX+70,y:pTop+pH*0.40});
        positions.push({x:pX-70,y:pTop+pH*0.15},{x:pX+70,y:pTop+pH*0.15});
      } else if(plan.format==="5+1"&&plan.formation==="2-1-2"){
        positions.push({x:pX,y:pTop+pH*0.88});
        positions.push({x:pX-70,y:pTop+pH*0.65},{x:pX+70,y:pTop+pH*0.65});
        positions.push({x:pX,y:pTop+pH*0.40});
        positions.push({x:pX-70,y:pTop+pH*0.15},{x:pX+70,y:pTop+pH*0.15});
      } else if(plan.format==="6+1"&&plan.formation==="3-2-1"){
        positions.push({x:pX,y:pTop+pH*0.88});
        positions.push({x:pX-90,y:pTop+pH*0.65},{x:pX,y:pTop+pH*0.65},{x:pX+90,y:pTop+pH*0.65});
        positions.push({x:pX-60,y:pTop+pH*0.38},{x:pX+60,y:pTop+pH*0.38});
        positions.push({x:pX,y:pTop+pH*0.12});
      } else { // 6+1 2-3-1
        positions.push({x:pX,y:pTop+pH*0.88});
        positions.push({x:pX-70,y:pTop+pH*0.65},{x:pX+70,y:pTop+pH*0.65});
        positions.push({x:pX-90,y:pTop+pH*0.40},{x:pX,y:pTop+pH*0.40},{x:pX+90,y:pTop+pH*0.40});
        positions.push({x:pX,y:pTop+pH*0.12});
      }
      return positions;
    }
    const tokPos=getTokenPositions();
    lineup.forEach((s,i)=>{
      const pos=tokPos[i]||{x:pX,y:pitchY+pitchH/2};
      const isGK=s.key==="GK";
      const r=20;
      // Shadow
      ctx.fillStyle="rgba(0,0,0,0.4)";ctx.beginPath();ctx.ellipse(pos.x,pos.y+r+2,r,6,0,0,Math.PI*2);ctx.fill();
      // Token circle
      ctx.fillStyle=isGK?"#d4af37":"#1e1e2e";
      ctx.strokeStyle=isGK?"#d4af37":"rgba(212,175,55,0.6)";ctx.lineWidth=2;
      ctx.beginPath();ctx.arc(pos.x,pos.y,r,0,Math.PI*2);ctx.fill();ctx.stroke();
      if(s.assigned){
        // Player number
        ctx.fillStyle=isGK?"#0b0b0f":"#fff";ctx.font="bold 13px 'Montserrat',sans-serif";ctx.textAlign="center";ctx.textBaseline="middle";
        const p=state.players.find(x=>x.id===s.assigned.playerId);
        ctx.fillText(String(p?.number??""),pos.x,pos.y);
        // Name below
        ctx.fillStyle="#fff";ctx.font="bold 9px 'Montserrat',sans-serif";ctx.textBaseline="top";
        ctx.fillText((s.assigned.name||"").slice(0,8),pos.x,pos.y+r+4);
        // Pos label
        ctx.fillStyle="rgba(255,255,255,0.5)";ctx.font="8px 'Montserrat',sans-serif";
        ctx.fillText(s.label,pos.x,pos.y-r-10);
      } else {
        ctx.fillStyle="rgba(212,175,55,0.5)";ctx.font="8px 'Montserrat',sans-serif";ctx.textAlign="center";ctx.textBaseline="middle";
        ctx.fillText(s.label,pos.x,pos.y);
      }
    });

    // Bank row
    const bench=plan.bench||[];
    if(bench.length){
      ctx.fillStyle="rgba(255,255,255,0.5)";ctx.font="11px 'Montserrat',sans-serif";ctx.textAlign="center";ctx.textBaseline="top";
      ctx.fillText(`Bank: ${bench.map(x=>x.name).join(", ")}`,W/2,pitchY+pitchH+8);
    }

    // Footer
    ctx.fillStyle="rgba(212,175,55,0.6)";ctx.font="10px 'Montserrat',sans-serif";ctx.textAlign="center";
    ctx.fillText("Ballers United â€“ Coach Tracker",W/2,H-10);

    // Download
    const link=document.createElement("a");
    link.download=`BU_Aufstellung_${g.date||"plan"}.jpg`;
    link.href=canvas.toDataURL("image/jpeg",0.93);
    link.click();
  }

  // init
  setDefaultAvail();
  if(!card.querySelector("#rules").value) card.querySelector("#rules").value=(plan.keyRules||[]).join("\n");
  card.querySelector("#format").value=plan.format;
  card.querySelector("#formation").value=plan.formation;
  card.querySelector("#meet").value=plan.meetMins;
  card.querySelector("#notes").value=plan.notes||"";
  renderChecklist();renderAvailability();renderSlots();renderBench();renderPool();

  card.querySelector("#gamePick").onchange=()=>{plan.game=currentGame();renderChecklist();};
  card.querySelector("#meet").oninput=()=>{plan.meetMins=parseInt(card.querySelector("#meet").value,10)||45;renderChecklist();};
  card.querySelector("#format").onchange=()=>{plan.format=card.querySelector("#format").value;renderSlots();renderBench();renderPool();};
  card.querySelector("#formation").onchange=()=>{plan.formation=card.querySelector("#formation").value;renderSlots();};
  card.querySelector("#poolMode").onchange=()=>{renderPool();renderBench();};
  card.querySelector("#auto").onclick=autoLineup;
  card.querySelector("#clear").onclick=()=>{plan.lineup=[];renderSlots();renderBench();renderPool();};
  card.querySelector("#savePlan").onclick=()=>{savePlan();alert("Matchplan gespeichert âœ…");};
  card.querySelector("#copyPlan").onclick=()=>{savePlan();copyText(buildMatchplanText());};
  card.querySelector("#copyCheck").onclick=()=>copyText(card.querySelector("#check").value);
  card.querySelector("#resetCheck").onclick=()=>resetChecklist();
  card.querySelector("#exportImg").onclick=exportLineupImage;

  return root;
}

// â”€â”€ MATCHES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderMatches(){
  const root=el(`<div class="grid"></div>`);
  // Ausstehende Ergebnisse aus Spielplan
  const now=new Date();
  const past=(state.schedule||[])
    .filter(g=>new Date(g.date+"T"+(g.time||"00:00")+":00")<now)
    .filter(g=>!(state.matches||[]).find(m=>m.scheduleId===g.id))
    .sort((a,b)=>b.date.localeCompare(a.date)).slice(0,6);
  const pendingSection=past.length?`
    <div class="notice" style="margin-bottom:14px;">
      <b>ğŸ“‹ Ausstehende Ergebnisse</b>
      <div style="margin-top:8px;display:flex;flex-wrap:wrap;gap:6px;">
        ${past.map(g=>`<button class="btn secondary" onclick="addMatchFromGame('${g.id}')">${g.date} â€“ ${escapeHtml(g.opponent)}</button>`).join("")}
      </div>
    </div>`:"";
  const card=el(`<div class="card">
    <div class="controls" style="justify-content:space-between;">
      <h2 style="margin:0;">Matches & Statistiken</h2>
      <button class="btn" id="add">+ Match eintragen</button>
    </div>
    <div class="sep"></div>
    ${pendingSection}
    <div class="table-wrap" id="matchTable">${renderMatchesTable()}</div>
  </div>`);
  card.querySelector("#add").onclick=()=>openMatchModal(null);
  root.appendChild(card);return root;
}
function renderMatchesTable(){
  const ms=[...(state.matches||[])].sort((a,b)=>(b.date||"").localeCompare(a.date||""));
  if(!ms.length) return `<p class="muted">Noch keine Ergebnisse â€“ klicke auf "+ Match eintragen" oder auf âš½ im Spielplan.</p>`;
  function scoreColor(s){if(!s||!s.includes(":"))return "";const[a,b]=s.split(":").map(Number);return a>b?"#57e389":a<b?"#ff6b7a":"var(--muted)";}
  function typeChip(m){return m.gameType==="Pokalspiel"?'<span class="chip green">ğŸ¥‡ Pokal</span>':m.gameType==="Testspiel"?'<span class="chip">ğŸ¯ Test</span>':'<span class="chip gold">ğŸ† Liga</span>';}
  function haChip(m){return m.home!==false?'<span class="chip gold">Heim</span>':'<span class="chip">AuswÃ¤rts</span>';}
  const tableHtml=`<table><thead><tr><th>Datum</th><th>Art</th><th>Gegner</th><th>Ergebnis</th><th>Notizen</th><th>Aktionen</th></tr></thead><tbody>`+
    ms.map(m=>`<tr>
      <td class="mono" style="white-space:nowrap">${m.date}</td>
      <td>${typeChip(m)}</td>
      <td><b>${escapeHtml(m.opponent||"-")}</b><br><small>${m.home!==false?"ğŸ  Heim":"âœˆï¸ AuswÃ¤rts"}</small></td>
      <td class="mono" style="font-weight:900;color:${scoreColor(m.score)};white-space:nowrap">${escapeHtml(m.score||"â€“")}</td>
      <td class="muted small">${escapeHtml(m.notes||"")}</td>
      <td><div class="row-actions">
        <button class="btn secondary" onclick="editMatch('${m.id}')">âœï¸</button>
        <button class="btn danger" onclick="deleteMatch('${m.id}')">ğŸ—‘</button>
      </div></td></tr>`).join("")+`</tbody></table>`;
  const cardsHtml=`<div class="mobile-card-list">`+ms.map(m=>`
    <div style="border:1px solid var(--line);border-radius:14px;padding:12px;margin-bottom:8px;background:rgba(18,18,26,.8);">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;">
        <div>
          <div style="font-weight:700;font-size:15px;">${escapeHtml(m.opponent||"-")}</div>
          <div class="muted small">${m.date}</div>
        </div>
        <div style="font-size:22px;font-weight:900;color:${scoreColor(m.score)};">${escapeHtml(m.score||"â€“")}</div>
      </div>
      <div style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:8px;">${typeChip(m)}${haChip(m)}</div>
      ${m.notes?`<div class="muted small" style="margin-bottom:8px;">${escapeHtml(m.notes)}</div>`:""}
      <div class="row-actions">
        <button class="btn secondary" onclick="editMatch('${m.id}')">âœï¸ Bearbeiten</button>
        <button class="btn danger" onclick="deleteMatch('${m.id}')">ğŸ—‘</button>
      </div>
    </div>`).join("")+`</div>`;
  return `<div class="mobile-cards">${tableHtml}${cardsHtml}</div>`;
}
function openMatchModal(match){
  const isNew=!match;
  const m=isNew?{
    id:uid(),date:new Date().toISOString().slice(0,10),
    opponent:"",home:true,gameType:"Ligaspiel",scheduleId:null,
    score:"",notes:"",teamFeedback:"",
    stats:(state.players||[]).map(p=>({playerId:p.id,available:p.squadRole==="Stammspieler",minutes:0,goals:0,assists:0,rating:6,yellow:0,red:0,feedback:""}))
  }:structuredClone(match);
  if(m.home===undefined) m.home=true;
  if(!m.gameType) m.gameType="Ligaspiel";
  const modal=el(`<div class="modal-overlay">
    <div class="modal-sheet wide">
      <div class="controls" style="justify-content:space-between;">
        <h2 style="margin:0;">${isNew?"Neues Match":"Match bearbeiten"}</h2>
        <button class="btn secondary" id="close">SchlieÃŸen</button>
      </div>
      <div class="inline" style="margin-top:12px;">
        <div><label>Datum</label><input id="date" type="date" value="${m.date}"></div>
        <div><label>Gegner</label><input id="opp" value="${escapeAttr(m.opponent||"")}"></div>
      </div>
      <div class="inline">
        <div><label>Spielart</label><select id="gameType">
          <option value="Ligaspiel" ${m.gameType==="Ligaspiel"?"selected":""}>ğŸ† Ligaspiel</option>
          <option value="Pokalspiel" ${m.gameType==="Pokalspiel"?"selected":""}>ğŸ¥‡ Pokalspiel</option>
          <option value="Testspiel" ${m.gameType==="Testspiel"?"selected":""}>ğŸ¯ Testspiel</option>
        </select></div>
        <div><label>Heim / AuswÃ¤rts</label><select id="homeAway">
          <option value="home" ${m.home!==false?"selected":""}>ğŸ  Heim</option>
          <option value="away" ${m.home===false?"selected":""}>âœˆï¸ AuswÃ¤rts</option>
        </select></div>
      </div>
      <div class="inline">
        <div><label>Ergebnis (Ballers United : Gegner)</label><input id="score" value="${escapeAttr(m.score||"")}" placeholder="z.B. 3:2"></div>
        <div><label>Notizen</label><input id="notes" value="${escapeAttr(m.notes||"")}"></div>
      </div>
      <label>Team-Feedback (fÃ¼r WhatsApp)</label>
      <textarea id="teamFb" placeholder="z.B. Gute erste Halbzeit, zweite HÃ¤lfte kompakter bleiben">${escapeHtml(m.teamFeedback||"")}</textarea>
      <div class="sep"></div>
      <div class="controls" style="justify-content:space-between;">
        <div><h2 style="margin:0;">Spieler-Stats</h2>
        <div class="muted small">Min=Minuten gespielt Â· T=Tore Â· V=Vorlagen Â· Note=1â€“10</div></div>
        <div class="controls">
          <button class="btn secondary" id="core">Stamm verfÃ¼gbar</button>
          <button class="btn secondary" id="all">Alle verfÃ¼gbar</button>
          <button class="btn secondary" id="none">Alle nicht</button>
          <button class="btn secondary" id="copyFb">ğŸ“‹ Feedback kopieren</button>
        </div>
      </div>
      <div class="sep"></div>
      <div class="table-wrap">
        <table><thead><tr><th>Spieler</th><th>Pos</th><th>Status</th><th>VerfÃ¼gbar</th><th>Min</th><th>T</th><th>V</th><th>Note</th><th>Gelb</th><th>Rot</th><th>Feedback</th></tr></thead><tbody>
        ${state.players.slice().sort((a,b)=>a.name.localeCompare(b.name)).map(p=>{
          const s=(m.stats||[]).find(x=>x.playerId===p.id)||{available:false,minutes:0,goals:0,assists:0,rating:6,yellow:0,red:0,feedback:""};
          return `<tr><td><b>${p.name}</b> <span class="pill">#${p.number??""}</span></td>
            <td><span class="chip">${posLabel(p.position)}</span></td>
            <td>${p.squadRole==="Stammspieler"?'<span class="chip gold">Stamm</span>':'<span class="chip">Joker</span>'}</td>
            <td><select data-av="${p.id}">
              <option value="yes" ${s.available?"selected":""}>Ja</option>
              <option value="no" ${s.available?"":"selected"}>Nein</option>
            </select></td>
            <td><input data-num="min" data-p="${p.id}" type="number" min="0" max="200" step="5" value="${s.minutes}" style="width:72px"></td>
            <td><input data-num="g" data-p="${p.id}" type="number" min="0" max="20" value="${s.goals}" style="width:60px"></td>
            <td><input data-num="a" data-p="${p.id}" type="number" min="0" max="20" value="${s.assists}" style="width:60px"></td>
            <td><input data-num="r" data-p="${p.id}" type="number" min="1" max="10" step="0.5" value="${s.rating}" style="width:68px"></td>
            <td><input data-num="y" data-p="${p.id}" type="number" min="0" max="2" value="${s.yellow}" style="width:56px"></td>
            <td><input data-num="red" data-p="${p.id}" type="number" min="0" max="1" value="${s.red}" style="width:56px"></td>
            <td><input data-fb="${p.id}" value="${escapeAttr(s.feedback||"")}" placeholder="Feedbackâ€¦" style="min-width:180px"></td>
          </tr>`;
        }).join("")}
        </tbody></table>
      </div>
      <div class="sep"></div>
      <div class="controls" style="justify-content:flex-end;">
        <button class="btn" id="save">Speichern</button>
      </div>
    </div></div>`);
  modal.querySelector("#close").onclick=()=>modal.remove();
  function setAvail(mode){modal.querySelectorAll("[data-av]").forEach(sel=>{
    const pid=sel.getAttribute("data-av");const p=state.players.find(x=>x.id===pid);
    if(mode==="core") sel.value=(p&&p.squadRole==="Stammspieler")?"yes":"no";
    if(mode==="all") sel.value="yes";if(mode==="none") sel.value="no";
  });}
  modal.querySelector("#core").onclick=()=>setAvail("core");
  modal.querySelector("#all").onclick=()=>setAvail("all");
  modal.querySelector("#none").onclick=()=>setAvail("none");
  modal.querySelector("#copyFb").onclick=()=>{
    const opp=modal.querySelector("#opp").value.trim()||"Gegner";
    const score=modal.querySelector("#score").value.trim();
    const team=(modal.querySelector("#teamFb")?.value||"").trim();
    const items=[];
    state.players.sort((a,b)=>a.name.localeCompare(b.name)).forEach(p=>{
      const fb=(modal.querySelector(`[data-fb="${p.id}"]`)?.value||"").trim();
      if(fb) items.push(`â€¢ *${p.name}:* ${fb}`);
    });
    const lines=[`ğŸŸ¨ğŸ–¤ *Ballers United â€“ Match Feedback*`,
      `ğŸ†š ${opp}${score?` Â· ${score}`:""}`];
    if(team) lines.push(`\n*Team:* ${team}`);
    if(items.length){lines.push(`\n*Spieler:*`);lines.push(...items);}
    copyText(lines.join("\n"));
  };
  modal.querySelector("#save").onclick=()=>{
    m.date=modal.querySelector("#date").value;
    m.opponent=modal.querySelector("#opp").value.trim();
    m.gameType=modal.querySelector("#gameType").value;
    m.home=modal.querySelector("#homeAway").value==="home";
    m.score=modal.querySelector("#score").value.trim();
    m.notes=modal.querySelector("#notes").value.trim();
    m.teamFeedback=(modal.querySelector("#teamFb")?.value||"").trim();
    const stats=[];
    state.players.forEach(p=>{
      const av=modal.querySelector(`[data-av="${p.id}"]`).value==="yes";
      function num(k,f){const inp=modal.querySelector(`[data-num="${k}"][data-p="${p.id}"]`);const v=inp?parseFloat(inp.value):NaN;return isNaN(v)?f:v;}
      const fb=(modal.querySelector(`[data-fb="${p.id}"]`)?.value||"").trim();
      stats.push({playerId:p.id,available:av,minutes:num("min",0),goals:num("g",0),assists:num("a",0),rating:num("r",6),yellow:num("y",0),red:num("red",0),feedback:fb});
    });
    m.stats=stats;
    const idx=state.matches.findIndex(x=>x.id===m.id);
    if(idx>=0) state.matches[idx]=m; else state.matches.push(m);
    saveState();render();modal.remove();
  };
  document.body.appendChild(modal);
}
window.editMatch=(id)=>{const m=state.matches.find(x=>x.id===id);if(m) openMatchModal(m);};
window.deleteMatch=(id)=>{if(!confirm("Match lÃ¶schen?")) return;state.matches=state.matches.filter(x=>x.id!==id);saveState();render();};

// â”€â”€ TAKTIKTAFEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTactics(){
  const root=el(`<div class="grid"></div>`);
  const card=el(`<div class="card">
    <div class="controls" style="justify-content:space-between;">
      <h2 style="margin:0;">ğŸŸ© Taktiktafel (Interaktiv)</h2>
      <div class="controls">
        <button class="btn secondary" id="clearTok">Alle entfernen</button>
        <button class="btn" id="exportTak">ğŸ“· Exportieren</button>
      </div>
    </div>
    <div class="notice" style="margin:10px 0;">Klicke auf einen Spieler unten â†’ dann auf das Feld, um ihn zu platzieren. Spielsteine verschieben per Drag & Drop. Doppelklick entfernt.</div>
    <div class="row two">
      <div>
        <div id="tacticsField">
          <svg id="pitchSvg" viewBox="0 0 300 450" preserveAspectRatio="none" xmlns="http://www.w3.org/2000/svg">
            <!-- Grass stripes -->
            <defs>
              <pattern id="grass" x="0" y="0" width="300" height="50" patternUnits="userSpaceOnUse">
                <rect width="300" height="25" fill="#2d7a2d"/>
                <rect y="25" width="300" height="25" fill="#287028"/>
              </pattern>
            </defs>
            <rect width="300" height="450" fill="url(#grass)"/>
            
            <!-- Outer border / Seitenlinien -->
            <rect x="10" y="10" width="280" height="430" fill="none" stroke="rgba(255,255,255,0.85)" stroke-width="2.5"/>
            
            <!-- Mittellinie -->
            <line x1="10" y1="225" x2="290" y2="225" stroke="rgba(255,255,255,0.85)" stroke-width="2"/>
            
            <!-- Mittelkreis -->
            <circle cx="150" cy="225" r="40" fill="none" stroke="rgba(255,255,255,0.85)" stroke-width="2"/>
            <!-- Mittelpunkt -->
            <circle cx="150" cy="225" r="3" fill="rgba(255,255,255,0.9)"/>
            
            <!-- â•â•â• OBERES TOR & STRAFRAUM â•â•â• -->
            <!-- GroÃŸer Strafraum oben -->
            <rect x="55" y="10" width="190" height="70" fill="none" stroke="rgba(255,255,255,0.85)" stroke-width="2"/>
            <!-- Kleiner Strafraum oben (5m-Raum) -->
            <rect x="100" y="10" width="100" height="28" fill="none" stroke="rgba(255,255,255,0.85)" stroke-width="1.8"/>
            <!-- Strafpunkt oben -->
            <circle cx="150" cy="58" r="2.5" fill="rgba(255,255,255,0.9)"/>
            <!-- Strafraumbogen oben -->
            <path d="M 90 80 A 40 40 0 0 1 210 80" fill="none" stroke="rgba(255,255,255,0.85)" stroke-width="2"/>
            <!-- Tor oben -->
            <rect x="118" y="4" width="64" height="12" fill="rgba(255,255,255,0.15)" stroke="rgba(255,255,255,0.9)" stroke-width="2.5" rx="1"/>
            <!-- Torpfosten Highlights -->
            <line x1="118" y1="4" x2="118" y2="10" stroke="white" stroke-width="3"/>
            <line x1="182" y1="4" x2="182" y2="10" stroke="white" stroke-width="3"/>
            <line x1="118" y1="4" x2="182" y2="4" stroke="white" stroke-width="2.5"/>
            
            <!-- â•â•â• UNTERES TOR & STRAFRAUM â•â•â• -->
            <!-- GroÃŸer Strafraum unten -->
            <rect x="55" y="370" width="190" height="70" fill="none" stroke="rgba(255,255,255,0.85)" stroke-width="2"/>
            <!-- Kleiner Strafraum unten -->
            <rect x="100" y="412" width="100" height="28" fill="none" stroke="rgba(255,255,255,0.85)" stroke-width="1.8"/>
            <!-- Strafpunkt unten -->
            <circle cx="150" cy="392" r="2.5" fill="rgba(255,255,255,0.9)"/>
            <!-- Strafraumbogen unten -->
            <path d="M 90 370 A 40 40 0 0 0 210 370" fill="none" stroke="rgba(255,255,255,0.85)" stroke-width="2"/>
            <!-- Tor unten -->
            <rect x="118" y="434" width="64" height="12" fill="rgba(255,255,255,0.15)" stroke="rgba(255,255,255,0.9)" stroke-width="2.5" rx="1"/>
            <!-- Torpfosten -->
            <line x1="118" y1="440" x2="118" y2="446" stroke="white" stroke-width="3"/>
            <line x1="182" y1="440" x2="182" y2="446" stroke="white" stroke-width="3"/>
            <line x1="118" y1="446" x2="182" y2="446" stroke="white" stroke-width="2.5"/>
            
            <!-- Ecken -->
            <path d="M 10 18 Q 10 10 18 10" fill="none" stroke="rgba(255,255,255,0.7)" stroke-width="1.8"/>
            <path d="M 282 10 Q 290 10 290 18" fill="none" stroke="rgba(255,255,255,0.7)" stroke-width="1.8"/>
            <path d="M 10 432 Q 10 440 18 440" fill="none" stroke="rgba(255,255,255,0.7)" stroke-width="1.8"/>
            <path d="M 282 440 Q 290 440 290 432" fill="none" stroke="rgba(255,255,255,0.7)" stroke-width="1.8"/>
          </svg>
        </div>
      </div>
      <div>
        <h2>Spieler auf Feld setzen</h2>
        <div class="notice small" style="margin-bottom:8px;">Spieler anklicken â†’ auf Feld tippen/klicken.</div>
        <div id="tokPool" style="display:flex;flex-wrap:wrap;gap:6px;max-height:300px;overflow-y:auto;"></div>
        <div class="sep"></div>
        <h2>Notizen / Taktik</h2>
        <textarea id="tacNotes" placeholder="Taktische Hinweise, Laufwege, Druckzonenâ€¦" style="min-height:120px;"></textarea>
      </div>
    </div>
    <canvas id="takCanvas" style="display:none;"></canvas>
  </div>`);
  root.appendChild(card);

  const field=card.querySelector("#tacticsField");
  const pool=card.querySelector("#tokPool");
  // tokens: {id, pid, name, number, position, x, y (percentage)}
  let tokens=[];
  let pendingPlayer=null; // player to place on next click

  function getPos(e,fieldEl){
    const r=fieldEl.getBoundingClientRect();
    const clientX=e.touches?e.touches[0].clientX:e.clientX;
    const clientY=e.touches?e.touches[0].clientY:e.clientY;
    return{x:Math.max(0,Math.min(100,(clientX-r.left)/r.width*100)),
           y:Math.max(0,Math.min(100,(clientY-r.top)/r.height*100))};
  }

  function renderTokens(){
    // Remove old tokens
    field.querySelectorAll(".player-token").forEach(t=>t.remove());
    tokens.forEach(tok=>{
      const isGK=normPos(tok.position)==="TW";
      const div=document.createElement("div");
      div.className="player-token";
      div.style.left=tok.x+"%";div.style.top=tok.y+"%";
      div.style.background=isGK?"#d4af37":"#1e1e2e";
      div.style.border=`2px solid ${isGK?"#d4af37":"rgba(212,175,55,0.7)"}`;
      div.innerHTML=`<span class="tok-num">${tok.number||""}</span><span class="tok-name">${tok.name.slice(0,8)}</span>`;
      div.title=tok.name;
      // Drag
      let dragging=false,ox=0,oy=0;
      div.addEventListener("mousedown",e=>{
        if(e.button!==0) return;dragging=true;
        const r2=field.getBoundingClientRect();
        ox=e.clientX-r2.left-tok.x/100*r2.width;
        oy=e.clientY-r2.top-tok.y/100*r2.height;
        e.stopPropagation();e.preventDefault();
      });
      div.addEventListener("touchstart",e=>{
        dragging=true;const r2=field.getBoundingClientRect();
        const t2=e.touches[0];
        ox=t2.clientX-r2.left-tok.x/100*r2.width;
        oy=t2.clientY-r2.top-tok.y/100*r2.height;
        e.stopPropagation();
      },{passive:true});
      div.addEventListener("dblclick",e=>{
        tokens=tokens.filter(t=>t.id!==tok.id);renderTokens();e.stopPropagation();
      });
      function onMove(e){
        if(!dragging) return;
        const r2=field.getBoundingClientRect();
        const cx=e.touches?e.touches[0].clientX:e.clientX;
        const cy=e.touches?e.touches[0].clientY:e.clientY;
        tok.x=Math.max(2,Math.min(98,(cx-ox-r2.left)/r2.width*100));
        tok.y=Math.max(2,Math.min(98,(cy-oy-r2.top)/r2.height*100));
        div.style.left=tok.x+"%";div.style.top=tok.y+"%";
      }
      function onUp(){dragging=false;}
      document.addEventListener("mousemove",onMove);document.addEventListener("mouseup",onUp);
      document.addEventListener("touchmove",onMove,{passive:true});document.addEventListener("touchend",onUp);
      field.appendChild(div);
    });
  }

  function renderPool(){
    pool.innerHTML=(state.players||[]).sort((a,b)=>a.name.localeCompare(b.name)).map(p=>{
      const onField=tokens.find(t=>t.pid===p.id);
      const isGK=normPos(p.position)==="TW";
      const active=pendingPlayer&&pendingPlayer.id===p.id;
      return `<button type="button" class="tab ${active?"active":""}" data-pid="${p.id}"
        style="font-size:12px;${onField?"opacity:.45":""}">
        ${isGK?"ğŸ§¤":"âš½"} <b>#${p.number||""}</b> ${escapeHtml(p.name)}
        <span class="chip" style="margin:0;">${posLabel(p.position)}</span>
      </button>`;
    }).join("");
    pool.querySelectorAll("[data-pid]").forEach(btn=>{
      btn.onclick=()=>{
        const pid=btn.getAttribute("data-pid");
        const p=state.players.find(x=>x.id===pid);
        if(!p) return;
        if(pendingPlayer&&pendingPlayer.id===pid){pendingPlayer=null;}
        else{pendingPlayer=p;}
        renderPool();
        field.style.cursor=pendingPlayer?"crosshair":"default";
      };
    });
  }

  field.addEventListener("click",e=>{
    if(!pendingPlayer) return;
    const{x,y}=getPos(e,field);
    // remove if already on field
    tokens=tokens.filter(t=>t.pid!==pendingPlayer.id);
    tokens.push({id:uid(),pid:pendingPlayer.id,name:pendingPlayer.name,number:pendingPlayer.number||"",position:pendingPlayer.position,x,y});
    pendingPlayer=null;
    renderTokens();renderPool();field.style.cursor="default";
  });
  field.addEventListener("touchend",e=>{
    if(!pendingPlayer) return;
    const touch=e.changedTouches[0];
    const r=field.getBoundingClientRect();
    const x=Math.max(0,Math.min(100,(touch.clientX-r.left)/r.width*100));
    const y=Math.max(0,Math.min(100,(touch.clientY-r.top)/r.height*100));
    tokens=tokens.filter(t=>t.pid!==pendingPlayer.id);
    tokens.push({id:uid(),pid:pendingPlayer.id,name:pendingPlayer.name,number:pendingPlayer.number||"",position:pendingPlayer.position,x,y});
    pendingPlayer=null;renderTokens();renderPool();field.style.cursor="default";
    e.preventDefault();
  },{passive:false});

  card.querySelector("#clearTok").onclick=()=>{tokens=[];pendingPlayer=null;renderTokens();renderPool();};

  card.querySelector("#exportTak").onclick=()=>{
    const canvas=card.querySelector("#takCanvas");
    const W=360,H=640;canvas.width=W;canvas.height=H;
    const ctx=canvas.getContext("2d");
    // Background
    ctx.fillStyle="#0b0b0f";ctx.fillRect(0,0,W,H);
    // Pitch
    const px=10,py=40,pw=W-20,ph=H-80;
    const g=ctx.createLinearGradient(px,py,px,py+ph);
    g.addColorStop(0,"#1a3d1a");g.addColorStop(.5,"#1e4820");g.addColorStop(1,"#163814");
    ctx.fillStyle=g;ctx.fillRect(px,py,pw,ph);
    ctx.strokeStyle="rgba(255,255,255,0.2)";ctx.lineWidth=1.5;
    ctx.strokeRect(px+4,py+4,pw-8,ph-8);
    ctx.beginPath();ctx.moveTo(px+4,py+ph/2);ctx.lineTo(px+pw-4,py+ph/2);ctx.stroke();
    ctx.beginPath();ctx.arc(px+pw/2,py+ph/2,24,0,Math.PI*2);ctx.stroke();
    // Tokens
    tokens.forEach(tok=>{
      const tx=px+tok.x/100*pw;const ty=py+tok.y/100*ph;
      const isGK=normPos(tok.position)==="TW";
      ctx.fillStyle=isGK?"#d4af37":"#1e1e2e";
      ctx.strokeStyle=isGK?"#d4af37":"rgba(212,175,55,0.7)";ctx.lineWidth=2;
      ctx.beginPath();ctx.arc(tx,ty,16,0,Math.PI*2);ctx.fill();ctx.stroke();
      ctx.fillStyle=isGK?"#0b0b0f":"#fff";ctx.font="bold 11px sans-serif";ctx.textAlign="center";ctx.textBaseline="middle";
      ctx.fillText(String(tok.number||""),tx,ty);
      ctx.fillStyle="#fff";ctx.font="bold 8px sans-serif";ctx.textBaseline="top";
      ctx.fillText(tok.name.slice(0,6),tx,ty+18);
    });
    // Notes
    const notes=(card.querySelector("#tacNotes").value||"").trim();
    if(notes){
      ctx.fillStyle="rgba(0,0,0,0.5)";ctx.fillRect(0,H-40,W,40);
      ctx.fillStyle="rgba(255,255,255,0.8)";ctx.font="10px sans-serif";ctx.textAlign="left";ctx.textBaseline="middle";
      ctx.fillText(notes.slice(0,60),10,H-20);
    }
    ctx.fillStyle="rgba(212,175,55,0.5)";ctx.font="9px sans-serif";ctx.textAlign="center";
    ctx.fillText("Ballers United",W/2,H-6);
    const link=document.createElement("a");link.download="BU_Taktiktafel.png";link.href=canvas.toDataURL("image/png");link.click();
  };

  renderTokens();renderPool();
  return root;
}

// â”€â”€ TRAININGSBIBLIOTHEK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function defaultLibrary(){
  return [
    {id:"dr1",title:"AufwÃ¤rmen: MobilitÃ¤t + BallgewÃ¶hnung (10')",tags:["aufwÃ¤rmen","koordination"],equip:"HÃ¼tchen, Ball",setup:"20x20m",steps:[
      "2' MobilitÃ¤t (HÃ¼fte/KnÃ¶chel), leichtes Laufen",
      "4' BallfÃ¼hrung: innen/auÃŸen, SohlenzÃ¼ge, Richtungswechsel",
      "4' Steigerungen mit Ball + kurzer Sprint (5â€“10m)"
    ],coaching:["Langsam starten â†’ warm werden","Kopf hoch, kleine Kontakte","Bei KÃ¤lte: Handschuhe/MÃ¼tze ok"]},
    {id:"dr2",title:"Rondo 4v1 / 5v2 (12')",tags:["passspiel","kombination"],equip:"HÃ¼tchen, BÃ¤lle",setup:"8x8m",steps:[
      "1â€“2 Kontakte, Ball zirkulieren",
      "Verlierer geht in die Mitte",
      "Progression: 1 Kontakt oder Pflicht-Doppelpass"
    ],coaching:["Anspielwinkel schaffen","Erster Kontakt weg vom Gegner","Kommunikation: 'Klatsch', 'Dreh', 'Zeit'"]},
    {id:"dr3",title:"Kombination â†’ Abschluss (15')",tags:["passspiel","abschluss"],equip:"GroÃŸes Tor, HÃ¼tchen, BÃ¤lle",setup:"Halbfeld 25â€“35m",steps:[
      "Passfolge Ã¼ber 2 Stationen â†’ Steil/Klatsch â†’ Abschluss",
      "Wechsel links/rechts",
      "Progression: Direktabschluss oder Abschluss nach 2 Kontakten"
    ],coaching:["Pass in den Lauf","Schuss schnell nach Ballannahme","Nachschuss/Abpraller aktiv"]},
    {id:"dr4",title:"Transition: 3-Sekunden-Druck (12')",tags:["defensive","transition"],equip:"HÃ¼tchen, 2 Mini-Tore",setup:"25x20m",steps:[
      "3v3 + 2 Mini-Tore",
      "Nach Ballverlust: Team hat 3 Sekunden fÃ¼r sofortigen Druck",
      "Danach: kompakt in Formation zurÃ¼ck"
    ],coaching:["Erste Reaktion zÃ¤hlt","NÃ¤chster Spieler attackiert, Rest sichert","Nicht wild jagen â€“ nach 3 Sek. Ordnung"]},
    {id:"dr5",title:"Kleinfeld-Match: 5+1-Prinzipien (20')",tags:["spielform"],equip:"Mini-Tore oder GroÃŸes Tor",setup:"je nach Platz",steps:[
      "Spiel 4v4/5v5 auf Mini-Tore oder 5v5+TW",
      "Regeln: max. 2 Kontakte hinten, RÃ¼ckpass ok, kein Dribbling hinten",
      "Bonuspunkt fÃ¼r Tor nach Doppelpass"
    ],coaching:["Dreiecke & Klatsch","Breite geben, dann innen spielen","Kompakt bleiben (AbstÃ¤nde!)"]}
  ];
}
function renderLibrary(){
  const root=el(`<div class="grid"></div>`);
  const card=el(`<div class="card">
    <div class="controls" style="justify-content:space-between;">
      <h2 style="margin:0;">Trainingsbibliothek</h2>
      <div class="controls">
        <button class="btn secondary" id="newPlan">+ Trainingsplan</button>
        <button class="btn" id="newDrill">+ Ãœbung</button>
      </div>
    </div>
    <div class="sep"></div>
    <div class="notice">Ãœbungen zusammenstellen â†’ Trainingsplan erstellen â†’ als WhatsApp-Text kopieren.</div>
    <div class="sep"></div>
    <div class="row two">
      <div><h2>Ãœbungen</h2><div id="drills"></div></div>
      <div><h2>TrainingsplÃ¤ne</h2><div id="plans"></div></div>
    </div>
  </div>`);
  root.appendChild(card);

  function drillCard(d){
    const tags=(d.tags||[]).map(t=>`<span class="chip">${escapeHtml(t)}</span>`).join("");
    const steps=(d.steps||[]).map(s=>`<li>${escapeHtml(s)}</li>`).join("");
    const coaching=(d.coaching||[]).map(s=>`<li>${escapeHtml(s)}</li>`).join("");
    const div=el(`<div class="card" style="margin-bottom:10px;">
      <div class="controls" style="justify-content:space-between;">
        <b>${escapeHtml(d.title)}</b>
        <div class="row-actions">
          <button class="btn secondary small" data-edit="${d.id}">âœï¸</button>
          <button class="btn danger small" data-del="${d.id}">ğŸ—‘</button>
        </div>
      </div>
      <div style="margin-top:4px;">${tags}</div>
      <div class="muted small" style="margin-top:6px;">AusrÃ¼stung: ${escapeHtml(d.equip||"")} Â· Setup: ${escapeHtml(d.setup||"")}</div>
      <div style="margin-top:6px;"><b style="font-size:11px;">Ablauf:</b><ol style="margin:4px 0 0 16px;padding:0;font-size:12px;">${steps}</ol></div>
      <div style="margin-top:6px;"><b style="font-size:11px;">Coaching-Punkte:</b><ul style="margin:4px 0 0 16px;padding:0;font-size:12px;color:var(--muted);">${coaching}</ul></div>
    </div>`);
    div.querySelector(`[data-edit="${d.id}"]`).onclick=()=>openDrillModal(d);
    div.querySelector(`[data-del="${d.id}"]`).onclick=()=>{
      if(!confirm(`Ãœbung "${d.title}" lÃ¶schen?`)) return;
      state.library=state.library.filter(x=>x.id!==d.id);saveState();renderDrills();
    };
    return div;
  }
  function renderDrills(){
    const box=card.querySelector("#drills");box.innerHTML="";
    (state.library||[]).forEach(d=>box.appendChild(drillCard(d)));
  }

  function openDrillModal(drill){
    const isNew=!drill;
    const d=isNew?{id:uid(),title:"",tags:[],equip:"",setup:"",steps:[""],coaching:[""]}:structuredClone(drill);
    const modal=el(`<div class="modal-overlay">
      <div class="modal-sheet">
        <div class="controls" style="justify-content:space-between;">
          <h2 style="margin:0;">${isNew?"Neue Ãœbung":"Ãœbung bearbeiten"}</h2>
          <button class="btn secondary" id="close">SchlieÃŸen</button>
        </div>
        <label>Titel</label><input id="title" value="${escapeAttr(d.title)}">
        <label>Tags (kommagetrennt)</label><input id="tags" value="${escapeAttr((d.tags||[]).join(", "))}">
        <label>AusrÃ¼stung</label><input id="equip" value="${escapeAttr(d.equip||"")}">
        <label>Setup / Feld</label><input id="setup" value="${escapeAttr(d.setup||"")}">
        <label>Ablauf (eine Zeile = ein Schritt)</label>
        <textarea id="steps">${escapeHtml((d.steps||[]).join("\n"))}</textarea>
        <label>Coaching-Punkte (eine Zeile = ein Punkt)</label>
        <textarea id="coaching">${escapeHtml((d.coaching||[]).join("\n"))}</textarea>
        <div class="sep"></div>
        <div class="controls" style="justify-content:flex-end;">
          <button class="btn" id="save">Speichern</button>
        </div>
      </div></div>`);
    modal.querySelector("#close").onclick=()=>modal.remove();
    modal.querySelector("#save").onclick=()=>{
      d.title=modal.querySelector("#title").value.trim();if(!d.title) return alert("Bitte Titel eingeben.");
      d.tags=modal.querySelector("#tags").value.split(",").map(x=>x.trim()).filter(Boolean);
      d.equip=modal.querySelector("#equip").value.trim();
      d.setup=modal.querySelector("#setup").value.trim();
      d.steps=modal.querySelector("#steps").value.split("\n").map(x=>x.trim()).filter(Boolean);
      d.coaching=modal.querySelector("#coaching").value.split("\n").map(x=>x.trim()).filter(Boolean);
      const idx=(state.library||[]).findIndex(x=>x.id===d.id);
      if(idx>=0) state.library[idx]=d; else{state.library=state.library||[];state.library.push(d);}
      saveState();renderDrills();modal.remove();
    };
    document.body.appendChild(modal);
  }

  card.querySelector("#newDrill").onclick=()=>openDrillModal(null);

  // Plans
  function renderPlans(){
    const box=card.querySelector("#plans");box.innerHTML="";
    (state.plans||[]).forEach(plan=>{
      const drillNames=(plan.drillIds||[]).map(id=>{const d=(state.library||[]).find(x=>x.id===id);return d?d.title:"?"}).join(" â†’ ");
      const p=el(`<div class="card" style="margin-bottom:10px;">
        <div class="controls" style="justify-content:space-between;">
          <b>${escapeHtml(plan.name||"Unbenannter Plan")}</b>
          <div class="row-actions">
            <button class="btn secondary" data-copy="${plan.id}">ğŸ“‹ WhatsApp</button>
            <button class="btn danger small" data-delp="${plan.id}">ğŸ—‘</button>
          </div>
        </div>
        <div class="muted small" style="margin-top:4px;">${escapeHtml(drillNames)||"Keine Ãœbungen"}</div>
      </div>`);
      p.querySelector(`[data-copy="${plan.id}"]`).onclick=()=>{
        const drills=(plan.drillIds||[]).map(id=>(state.library||[]).find(x=>x.id===id)).filter(Boolean);
        const txt=[`ğŸŸ¨ğŸ–¤ *Ballers United â€“ Trainingsplan: ${plan.name||""}*`,``,...drills.map((d,i)=>[
          `${i+1}. *${d.title}*`,`ğŸ“‹ ${d.steps?.join(" â†’ ")||""}`,`ğŸ—£ ${d.coaching?.join(" Â· ")||""}`].join("\n"))].join("\n\n");
        copyText(txt);
      };
      p.querySelector(`[data-delp="${plan.id}"]`).onclick=()=>{
        if(!confirm(`Plan "${plan.name}" lÃ¶schen?`)) return;
        state.plans=state.plans.filter(x=>x.id!==plan.id);saveState();renderPlans();
      };
      box.appendChild(p);
    });
  }

  card.querySelector("#newPlan").onclick=()=>{
    const name=prompt("Name des Trainingsplans:");if(!name) return;
    const available=(state.library||[]);
    const chosen=[];
    const modal=el(`<div class="modal-overlay">
      <div class="modal-sheet">
        <div class="controls" style="justify-content:space-between;">
          <h2 style="margin:0;">Ãœbungen auswÃ¤hlen</h2>
          <button class="btn secondary" id="close">SchlieÃŸen</button>
        </div>
        <div style="margin-top:10px;">
          ${available.map(d=>`<label style="display:flex;gap:8px;align-items:center;margin:8px 0;cursor:pointer;">
            <input type="checkbox" data-did="${d.id}" style="width:auto;"> ${escapeHtml(d.title)}
          </label>`).join("")}
        </div>
        <div class="sep"></div>
        <div class="controls" style="justify-content:flex-end;">
          <button class="btn" id="create">Plan erstellen</button>
        </div>
      </div></div>`);
    modal.querySelector("#close").onclick=()=>modal.remove();
    modal.querySelector("#create").onclick=()=>{
      const ids=[...modal.querySelectorAll("[data-did]:checked")].map(cb=>cb.getAttribute("data-did"));
      state.plans=state.plans||[];
      state.plans.push({id:uid(),name,drillIds:ids});
      saveState();renderPlans();modal.remove();
    };
    document.body.appendChild(modal);
  };

  renderDrills();renderPlans();
  return root;
}

// â”€â”€ BACKUP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderBackup(){
  const root=el(`<div class="grid"></div>`);
  const card=el(`<div class="row two">
    <div class="card">
      <h2>Export</h2>
      <div class="controls">
        <button class="btn" id="exp">Daten exportieren</button>
        <button class="btn secondary" id="copy">In Zwischenablage</button>
      </div>
      <div class="sep"></div>
      <textarea id="out" class="mono" placeholder="Exportierter JSONâ€¦" style="min-height:200px;"></textarea>
    </div>
    <div class="card">
      <h2>Import</h2>
      <div class="notice" style="margin-bottom:10px;">âš ï¸ Import Ã¼berschreibt <b>alle</b> Daten!</div>
      <textarea id="inp" class="mono" placeholder="JSON hier einfÃ¼genâ€¦" style="min-height:200px;"></textarea>
      <div class="sep"></div>
      <div class="controls">
        <button class="btn danger" id="imp">Import (Ã¼berschreibt)</button>
        <button class="btn secondary" id="reset">Auf Standard zurÃ¼cksetzen</button>
      </div>
    </div>
  </div>`);
  const out=card.querySelector("#out");
  card.querySelector("#exp").onclick=()=>{out.value=JSON.stringify(state,null,2);};
  card.querySelector("#copy").onclick=async()=>{
    try{await navigator.clipboard.writeText(out.value||JSON.stringify(state,null,2));alert("Kopiert âœ…");}
    catch(e){alert("Bitte manuell kopieren.");}
  };
  card.querySelector("#imp").onclick=()=>{
    const txt=card.querySelector("#inp").value.trim();if(!txt) return alert("Kein JSON.");
    if(!confirm("Import Ã¼berschreibt alle Daten. Fortfahren?")) return;
    try{const p=JSON.parse(txt);state=Object.assign(structuredClone(SEED),p);migrateState();saveState();render();alert("Import OK âœ…");}
    catch(e){alert("UngÃ¼ltiges JSON: "+e.message);}
  };
  card.querySelector("#reset").onclick=()=>{
    if(!confirm("Alle Daten auf Standard zurÃ¼cksetzen?")) return;
    state=structuredClone(SEED);migrateState();saveState();render();
  };
  root.appendChild(card);return root;
}

// â”€â”€ COPY HELPER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function copyText(txt){
  return navigator.clipboard?.writeText(txt)
    .then(()=>alert("In die Zwischenablage kopiert âœ…"))
    .catch(()=>prompt("Kopieren:",txt));
}

render();
</script>
<script>
if("serviceWorker" in navigator){
  window.addEventListener("load",()=>{
    navigator.serviceWorker.register("./sw.js").catch(console.warn);
  });
}
</script>
</body></html>
